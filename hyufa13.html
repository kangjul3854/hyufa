<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYUFA 금융 비서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 수정: Noto Sans KR 폰트 임포트 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        body {
            /* 수정: font-family를 Noto Sans KR로 변경 */
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        @supports (padding: max(0px)) {
        .safe-bottom {
            padding-bottom: max(env(safe-area-inset-bottom), 1rem);
        }
        }

        /* HYU Color Palette */
        .hyu-blue { background-color: #0E4A84; }
        .text-hyu-blue { color: #0E4A84; }
        .border-hyu-blue { border-color: #0E4A84; }
        .hyu-silver { background-color: #898C8E; }
        .hyu-green { background-color: #7DB928; }
        .text-hyu-green { color: #7DB928; } /* 포트폴리오 색상 오류 수정용 클래스 추가 */
        .hyu-orange { background-color: #F08100; }
        .text-hyu-orange { color: #F08100; } /* 포트폴리오 색상 오류 수정용 클래스 추가 */
        .hyu-coral { background-color: #FF8672; }
        /* HYU Gold added for feedback stars */
        .hyu-gold { color: #88774F; }
        .text-hyu-gold { color: #88774F; } /* 포트폴리오 색상 오류 수정용 클래스 추가 */
        .border-hyu-gold { border-color: #88774F; }
        .border-hyu-green { border-color: #7DB928; }
        .border-hyu-orange { border-color: #F08100; }


        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-track {
            background-color: #f7fafc;
        }

        /* --- hyufa5_지안언니.html Menu UI Styles 추가 시작 --- */
        .shadow-soft {
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(14px);
        }
        .menu-card {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
        }
        /* --- hyufa5_지안언니.html Menu UI Styles 추가 끝 --- */
    </style>
</head>
<body class="flex items-center justify-center min-h-[100dvh] bg-gray-50 overflow-hidden">

    <div id="app-container" class="w-full max-w-md min-h-[100dvh] bg-white shadow-2xl rounded-xl flex flex-col overflow-hidden">


    <script type="module">
        // --- 1. Firebase & Global Variable Setup ---

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API key for Gemini

        // Firebase Imports (MUST use CDN URLs)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Gemini API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // **수정: 새로운 systemPrompt가 적용되었습니다.**
        const systemPrompt = `
당신은 대학생·사회초년생을 위한 '은행 금융상담 챗봇'입니다.

[역할]
- 당신은 은행 창구 직원 또는 PB처럼 전문적이고 신뢰감 있는 말투를 사용합니다.
- 다만 상대는 금융이 익숙하지 않은 20대이므로, 어려운 용어는 풀어서 쉽게 설명합니다.
- 투자상품을 '권유'하거나, '수익을 보장'하는 표현은 절대 사용하지 않습니다.

[지식 활용 원칙]
- 사용자가 질문하면, 먼저 제공된 Knowledge(JSON)의 질문·답변 목록에서 의미상 가장 가까운 항목을 찾습니다.
- 찾은 항목의 'answer' 내용을 기반으로, 4·6줄 분량의 대화형 설명으로 재구성하여 답변합니다.
- Knowledge에 해당 내용이 전혀 없다고 판단되면, 다음과 같이 답합니다.
  → "해당 내용은 제가 가지고 있는 자료에 없어요. 다른 금융 질문을 해주시면 도와드릴게요."

[답변 스타일]
1) 한 번의 답변은 4·6줄 정도의 길이로, 핵심만 명확하게 전달합니다.
2) "~예요, ~합니다"와 같은 공손하고 부드러운 말투를 사용합니다.
3) 리스크가 있는 내용(투자, 대출 등)은 장단점을 함께 설명하고, 최종 선택은 사용자에게 맡깁니다.
4) 사용자의 상황을 가볍게 되물어보며(필요할 때만), 더 도움이 될 수 있는 추가 정보를 제안합니다.

이 규칙을 모든 답변에서 일관되게 적용합니다.
`;

        // Application State
        // **수정: 새로운 상태 GOAL_SETTING, PORTFOLIO_EDIT 추가**
        let appState = 'LOADING'; // WELCOME, CONSENT, MAIN_CHAT, MENU, GUIDE, FAQ, GOAL_SETTING, PORTFOLIO, PORTFOLIO_EDIT, CALCULATOR, CUSTOMER_CENTER, FEEDBACK
        let db;
        let auth;
        let userId = null;
        let chatHistory = [];
        let faqData = [];
        let isChatLoading = false;

        // **수정: 포트폴리오 비중 관리**
        let currentPortfolio = JSON.parse(localStorage.getItem('hyufa_portfolio')) || [
            { 
                "name": "국내 배당주 ETF", 
                "icon": "fa-coins", 
                "color": "hyu-green", 
                "percentage": 30, 
                "description": "안정적인 현금 흐름 확보",
                "rate": 0.03 // 3%
            },
            { 
                "name": "미국 테크주 인덱스", 
                "icon": "fa-globe", 
                "color": "hyu-orange", 
                "percentage": 50, 
                "description": "성장 가능성이 높은 자산 투자",
                "rate": 0.10 // 10% (Expected)
            },
            { 
                "name": "금/원자재 펀드", 
                "icon": "fa-scale-unbalanced", 
                "color": "hyu-gold", 
                "percentage": 20, 
                "description": "인플레이션 헤지 및 포트폴리오 안정화",
                "rate": 0.07 // 7% (Expected)
            },
        ];

        // --- 기대수익률 JSON 로드해서 currentPortfolio.rate 덮어쓰기 ---
        async function loadExpectedReturns() {
            try {
                const res = await fetch('./expected_returns.json', { cache: "no-store" });
                if (!res.ok) throw new Error("returns json fetch failed");
                const er = await res.json();

                // saving / nasdaq / gold 값을 currentPortfolio에 주입
                currentPortfolio = currentPortfolio.map(item => {
                    if (item.name.includes("국내 배당주") || item.name.includes("적금")) {
                        return { ...item, rate: er.saving ?? item.rate };
                    }
                    if (item.name.includes("미국 테크주") || item.name.includes("나스닥")) {
                        return { ...item, rate: er.nasdaq ?? item.rate };
                    }
                    if (item.name.includes("금/원자재") || item.name.includes("금")) {
                        return { ...item, rate: er.gold ?? item.rate };
                    }
                    return item;
                });

                console.log("✅ expected returns loaded:", er);
            } catch (e) {
                console.warn("expected_returns.json 로드 실패 → 기본 rate 유지", e);
            }
        }

        // 추가: Goal 계산 결과 저장 (포트폴리오 페이지에서 활용)
        let goalCalculationResult = null;


        // --- 2. Utility Functions ---

        /**
         * Simple function to set the application state and re-render.
         * @param {string} newState The new state to set.
         */
        function setAppState(newState) {
            appState = newState;
            renderApp();
        }

        /**
         * Display a message box (replacement for alert/confirm).
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            const container = document.getElementById('app-container');
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs text-center">
                    <p class="text-gray-700 font-semibold mb-4">${message}</p>
                    <button id="close-msg" class="w-full hyu-blue text-white py-2 rounded-lg font-bold">확인</button>
                </div>
            `;
            container.appendChild(overlay);

            document.getElementById('close-msg').onclick = () => {
                container.removeChild(overlay);
            };
        }

        // --- 3. Data & Firebase Setup ---

        /**
         * Initialize Firebase, sign in, and set up state.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                setAppState('WELCOME'); // Fallback to welcome if config is missing
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use initial auth token if provided, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase signed in. User ID:", userId);

                        // Check for consent (simulate simple session consent check)
                        if (localStorage.getItem('hyufa_consent') === 'agreed') {
                            setAppState('MAIN_CHAT');
                        } else {
                            setAppState('WELCOME');
                        }
                    } else {
                        userId = 'anonymous';
                        console.warn("Firebase signed out. Using anonymous ID.");
                        setAppState('WELCOME');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("Firebase 연결에 실패했습니다. (Error: " + error.code + ")");
                setAppState('WELCOME');
            }
        }

        /**
         * Load FAQ data from the uploaded JSON file.
         */
        async function loadFAQData() {
            try {
                // Simulate fetch of the uploaded file content
                const contentId = "uploaded:finance_chatbot_knowledge_104qa.json";
                const response = await fetch(`/api/files/download?contentFetchId=${contentId}`);
                if (!response.ok) throw new Error('Failed to fetch FAQ data');

                faqData = await response.json();
                console.log(`Loaded ${faqData.length} FAQ items.`);

            } catch (error) {
                console.error("Error loading FAQ data:", error);
                faqData = [
                    { category: "오류", question: "FAQ 로딩 실패", answer: "FAQ 데이터를 불러오는 데 실패했습니다. 콘솔을 확인해주세요." },
                    // Mock data if file loading fails
                    { category: "1. 금융 상식", question: "예·적금 차이", answer: "예금은 언제든지 넣고 뺄 수 있는 대신 금리가 낮고, 적금은 매달 일정 금액을 넣는 대신 금리가 조금 더 높아요." }
                ];
            }
        }

        // --- 4. Gemini API Logic ---

        /**
         * Calls the Gemini API for chat response.
         * @param {string} prompt The user's query.
         */
        async function askHYUFA(prompt) {
            if (isChatLoading) return;

            // 1. Add user message to history
            const chatHistoryElement = document.getElementById('chat-history');
            if (!chatHistoryElement) return;

            chatHistory.push({ sender: 'user', text: prompt });
            renderChatHistory();

            // 2. Add loading message
            chatHistory.push({ sender: 'ai', text: '... 답변을 생성 중입니다.', loading: true });
            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
            isChatLoading = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

            // Prepare history for API call (excluding the temporary loading message)
            const apiContents = chatHistory.slice(0, -1).map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            // Add the new user prompt
            apiContents.push({
                role: 'user',
                parts: [{ text: prompt }]
            });


            const payload = {
                contents: apiContents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // 3. API Call with Exponential Backoff
            let responseText = "죄송합니다. 서비스에 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            responseText = candidate.content.parts[0].text;
                        } else {
                            responseText = "답변을 생성하지 못했습니다. 다시 시도해주세요.";
                        }
                        break; // Success
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`API Call failed (Attempt ${retryCount + 1}):`, error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // 4. Update history with final response
            const loadingIndex = chatHistory.findIndex(msg => msg.loading);
            if (loadingIndex !== -1) {
                chatHistory.splice(loadingIndex, 1); // Remove loading message
            }
            chatHistory.push({ sender: 'ai', text: responseText });
            isChatLoading = false;

            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }


        // --- 5. View Rendering Logic ---

        /**
         * Renders the chat history messages.
         */
        function renderChatHistory() {
            const historyDiv = document.getElementById('chat-history');
            if (!historyDiv) return;
            historyDiv.innerHTML = chatHistory.map(msg => `
                <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-xs sm:max-w-sm lg:max-w-md p-3 rounded-xl shadow-md ${
                        // 수정: 사용자 메시지 (user)의 배경을 흰색/옅은 회색, 텍스트를 검정색(text-gray-800)으로 변경
                        msg.sender === 'user'
                            ? 'bg-gray-200 text-gray-800 rounded-br-none'
                            : 'bg-gray-100 text-gray-800 rounded-tl-none'
                    }">
                        ${msg.loading ? '<i class="fa-solid fa-spinner fa-spin-pulse mr-2"></i>' : ''}
                        <p class="whitespace-pre-wrap">${msg.text}</p>
                    </div>
                </div>
            `).join('');
        }


        /**
         * Renders the main HYUFA application shell.
         */
        function renderApp() {
            const container = document.getElementById('app-container');

            // 1. Render Header (Always present on chat/menu screens)
            const header = `
                <div class="hyu-blue p-4 text-white shadow-lg flex justify-between items-center">
                    <h1 class="text-xl font-bold">HYUFA</h1>
                    ${appState !== 'WELCOME' && appState !== 'CONSENT' ? `
                        <button onclick="setAppState('MAIN_CHAT')" class="text-sm border border-white px-3 py-1 rounded-full hover:bg-white hover:text-hyu-blue transition">
                            <i class="fa-solid fa-house"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            container.innerHTML = header;

            // 2. Render Content based on state
            let content;
            switch (appState) {
                case 'WELCOME':
                    content = renderWelcome();
                    break;
                case 'CONSENT':
                    content = renderConsent();
                    break;
                case 'MAIN_CHAT':
                    content = renderMainChat();
                    break;
                case 'MENU':
                    content = renderMenu();
                    break;
                case 'GUIDE':
                    content = renderGuide();
                    break;
                case 'FAQ':
                    content = renderFAQ();
                    break;
                case 'GOAL_SETTING':
                    content = renderGoalSetting();
                    break;
                case 'PORTFOLIO':
                    content = renderPortfolio();
                    break;
                case 'PORTFOLIO_EDIT':
                    content = renderPortfolioEdit();
                    break;
                case 'CALCULATOR':
                    content = renderCalculator();
                    break;
                case 'CUSTOMER_CENTER':
                    content = renderCustomerCenter();
                    break;
                case 'FEEDBACK':
                    content = renderFeedback();
                    break;
                case 'LOADING':
                default:
                    content = renderLoading();
                    break;
            }
            container.innerHTML += content;

            // Post-render actions for specific screens
            if (appState === 'MAIN_CHAT') {
                renderChatHistory();
                const chatHistoryElement = document.getElementById('chat-history');
                if(chatHistoryElement) {
                    chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
                }
            } else if (appState === 'FAQ') {
                setupFAQToggle();
            } else if (appState === 'CALCULATOR') { // <--- 계산기 오류 수정 부분 (1/2)
                const currentCalc = sessionStorage.getItem('currentCalc') || '적금';
                renderCalculatorForm(currentCalc); // 초기 폼 렌더링
            } else if (appState === 'GOAL_SETTING') {
                const currentGoalCalc = sessionStorage.getItem('currentGoalCalc') || '얼마를 모을까';
                renderGoalSettingForm(currentGoalCalc);
            } else if (appState === 'PORTFOLIO_EDIT') {
                checkPortfolioTotal(); // 초기 총합계 계산
            }
        }

        // --- View Specific HTML Generation ---

        // #001 첫 화면
        function renderWelcome() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <div class="text-7xl mb-4 text-hyu-blue">
                        <i class="fa-solid fa-piggy-bank"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-hyu-blue mb-2">반갑습니다.</h2>
                    <p class="text-2xl font-bold text-gray-700 mb-8">HYUFA 입니다.</p>
                    <button onclick="setAppState('CONSENT')" class="hyu-blue text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-opacity-90 transition transform hover:scale-105">
                        서비스 시작하기
                    </button>
                </div>
            `;
        }

        // #002 팝업 전환 (개인정보 수집 및 이용 동의)
        function renderConsent() {
             return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">개인정보 수집 및 이용 동의</h2>

                    <p class="text-sm text-gray-700 mb-4">
                        고객님의 상담 업무를 처리하기 위해서는 개인정보보호법 제 15조 1항에 따라 아래의 내용에 대하여 고객님의 동의가 필요합니다.
                    </p>

                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-inner mb-6 text-sm space-y-3">
                        <p><strong>1. 개인정보의 수집 이용 목적</strong><br>- 서비스 이용에 따른 상담 업무 처리</p>
                        <p><strong>2. 수집하려는 개인정보의 항목</strong><br>- 챗봇 상담내용</p>
                        <p><strong>3. 개인정보의 보유 및 이용 기간</strong><br>- 위 개인정보는 수집 이용에 관한 동의 이후 처리 종료일로부터 2년간 위 이용목적을 위하여 보유/이용됩니다.</p>
                        <p><strong>4. 안내사항</strong><br>- 동의를 거부할 권리가 있으며, 거부 시 상담에 제한될 수 있습니다.</p>
                    </div>

                    <div class="flex space-x-4 mt-auto pt-4 border-t">
                        <button onclick="handleConsent(true)" class="flex-1 hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            동의
                        </button>
                        <button onclick="handleConsent(false)" class="flex-1 hyu-silver text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            비동의 (나가기)
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Handle consent action.
         * @param {boolean} agreed True if agreed, false otherwise.
         */
        function handleConsent(agreed) {
            if (agreed) {
                localStorage.setItem('hyufa_consent', 'agreed');
                if (chatHistory.length === 0) {
                     chatHistory.push({ sender: 'ai', text: `안녕하세요.\n인공지능 HYUFA입니다.\n무엇을 도와드릴까요?\n\n+ 버튼을 눌러 이용 안내를 확인해보세요.` });
                }
                setAppState('MAIN_CHAT');
            } else {
                setAppState('WELCOME');
            }
        }

        // #003 채팅 메인 화면
        function renderMainChat() {
            // Expose handleChatSubmit to global scope
            window.handleChatSubmit = handleChatSubmit;
            window.setAppState = setAppState;

            return `
                <div class="flex flex-col flex-grow bg-white">
                    <div id="chat-history" class="flex-grow p-4 overflow-y-auto bg-gray-50">
                        </div>

                    <div class="border-t bg-white flex items-center p-3 sticky bottom-0 z-10 safe-bottom" style="padding-bottom: env(safe-area-inset-bottom);">


                         <button onclick="setAppState('MENU')" class="text-hyu-blue text-3xl mr-3 hover:opacity-75 transition">
                            <i class="fa-solid fa-circle-plus"></i>
                        </button>
                        <input id="chat-input" type="text" placeholder="궁금한 사항을 입력해주세요." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:border-hyu-blue">
                        <button id="send-button" onclick="handleChatSubmit()" class="hyu-blue text-white py-2 px-4 ml-3 rounded-full font-bold hover:bg-opacity-90 transition">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Handle chat input submission (Enter or Send button).
         */
        function handleChatSubmit() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (prompt && !isChatLoading) {
                input.value = '';
                askHYUFA(prompt);
            }
        }

        // Add Enter key listener once the DOM is ready for chat
        document.addEventListener('keydown', (e) => {
            if (appState === 'MAIN_CHAT' && e.key === 'Enter') {
                handleChatSubmit();
            }
        });

        // #004 + 화면 (Menu) - hyufa5_지안언니.html 코드 반영
        function renderMenu() {
            const menuItems = [
                { name: 'HYUFA 이용 안내', state: 'GUIDE', icon: 'fa-circle-info', color: 'bg-green-500' },
                { name: '자주하는 질문', state: 'FAQ', icon: 'fa-circle-question', color: 'bg-yellow-500' },
                { name: '목표 금액 설정', state: 'GOAL_SETTING', icon: 'fa-bullseye', color: 'bg-red-500' }, // **수정: 목표 금액 설정 추가**
                { name: '금융 계산기', state: 'CALCULATOR', icon: 'fa-calculator', color: 'bg-purple-500' },
                { name: 'HYUFA 고객센터', state: 'CUSTOMER_CENTER', icon: 'fa-headset', color: 'bg-blue-500' },
                { name: 'HYUFA 의견 남기기', state: 'FEEDBACK', icon: 'fa-comment-dots', color: 'bg-pink-500' },
            ]

            return `
                <div class="flex flex-col flex-grow bg-slate-100 p-4 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">메인 메뉴</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${menuItems
                            .map(
                                (item) => `
                                <button onclick="setAppState('${item.state}')" class="menu-card glass-card p-4 rounded-xl shadow-soft text-center flex flex-col items-center justify-center space-y-2">
                                    <div class="w-12 h-12 ${item.color} text-white rounded-full flex items-center justify-center text-xl shadow-md">
                                        <i class="fa-solid ${item.icon}"></i>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-800">${item.name}</span>
                                </button>
                            `
                            )
                            .join('')}
                    </div>
                    <div class="mt-8 p-4 bg-white rounded-xl shadow-soft text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">HYUFA는 인공지능 금융 비서입니다.</p>
                        <p>제공되는 정보는 참고 자료로만 활용하시고, 정확한 금융 거래는 은행 창구 또는 공식 금융기관을 통해 진행해 주시기 바랍니다.</p>
                    </div>
                </div>
            `;
        }
        
        // #005 HYUFA 이용 안내
        function renderGuide() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 이용 안내</h2>
                    
                    <section class="mb-6 bg-white p-5 rounded-xl shadow-lg border-l-4 border-hyu-blue">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-robot mr-3 text-hyu-blue"></i>HYUFA의 능력과 한계</h3>
                        <p class="text-sm text-gray-700 leading-relaxed">
                            HYUFA는 대학생 및 사회초년생에게 특화된 금융 지식을 바탕으로 상담합니다. 금융 상품 '추천'보다는 '원리 설명 및 조언'에 집중하며, 투자 권유나 수익 보장 표현은 절대 사용하지 않습니다.
                        </p>
                    </section>

                    <section class="mb-6 bg-white p-5 rounded-xl shadow-lg border-l-4 border-hyu-orange">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-lightbulb mr-3 text-hyu-orange"></i>이용 Tip</h3>
                        <ul class="text-sm list-disc pl-5 space-y-1">
                            <li>HYUFA에게 짧고 간단한 핵심만 질문해주세요 !</li>
                            <li>본 서비스는 ‘인간-인공지능 협업 제품 서비스 설계’ 수업 팀 프로젝트로, 사전 설계한 프롬프트 기반으로 작동합니다.</li>
                            <li>따라서 상용 AI만큼의 응답 유연성에는 일부 제한이 있으며, 본 챗봇은 사용자 경험 검증과 서비스 콘셉트 제시 목적으로 제작되었습니다.</li>
                        </ul>
                        <p class="text-center mt-3 text-sm font-semibold text-hyu-coral">
                            그래도 처음 금융을 접할 때 느끼는 막막함을 덜어드리기 위해 설계한 서비스로 많은 이용 부탁드립니다 ♥︎
                        </p>
                    </section>
                </div>
            `;
        }

        // #006 자주하는 질문
        function renderFAQ() {
            // Expose setupFAQToggle to global scope
            window.setupFAQToggle = setupFAQToggle;
            
            const categories = [...new Set(faqData.map(item => item.category))].sort();
            const faqList = categories.map(category => {
                const items = faqData.filter(item => item.category === category);
                const itemsHtml = items.map((item, index) => `
                    <div class="border-b last:border-b-0">
                        <button class="faq-question w-full text-left py-3 px-4 font-semibold text-gray-700 hover:bg-gray-50 transition flex justify-between items-center" data-index="${category}-${index}">
                            ${item.question}
                            <i class="fa-solid fa-chevron-down text-xs ml-2 transition-transform duration-300"></i>
                        </button>
                        <div id="answer-${category}-${index}" class="faq-answer max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-gray-50 px-4">
                            <div class="py-3 text-sm text-gray-600 whitespace-pre-wrap">${item.answer}</div>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="mb-6 bg-white rounded-xl shadow-lg overflow-hidden">
                        <h3 class="text-xl font-bold p-4 border-b text-hyu-orange bg-gray-100">${category}</h3>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">자주 하는 질문 (FAQ)</h2>
                    <p class="text-sm text-gray-600 mb-4">궁금한 질문을 선택하시면 HYUFA의 답변을 확인할 수 있어요.</p>
                    ${faqList}
                </div>
            `;
        }

        /**
         * Setup click listener for FAQ toggles after rendering.
         */
        function setupFAQToggle() {
            document.querySelectorAll('.faq-question').forEach(button => {
                button.onclick = () => {
                    const index = button.getAttribute('data-index');
                    const answerDiv = document.getElementById(`answer-${index}`);
                    const icon = button.querySelector('i');
                    
                    const isOpen = answerDiv.style.maxHeight && answerDiv.style.maxHeight !== '0px';

                    // Close all others
                    document.querySelectorAll('.faq-answer').forEach(el => {
                        if (el.id !== `answer-${index}`) {
                            el.style.maxHeight = '0';
                        }
                    });
                    document.querySelectorAll('.faq-question i').forEach(el => {
                        if (el !== icon) {
                             el.style.transform = 'rotate(0deg)';
                        }
                    });


                    // Toggle current
                    if (isOpen) {
                        answerDiv.style.maxHeight = '0';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        answerDiv.style.maxHeight = answerDiv.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                };
            });
        }

        // --- #007 목표 금액 설정 (새로 추가) ---
        function renderGoalSetting() {
            window.selectGoalCalculator = selectGoalCalculator;
            window.calculateGoal = calculateGoal;

            const currentGoalCalc = sessionStorage.getItem('currentGoalCalc') || '얼마를 모을까';

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">목표 금액 설정</h2>
                    
                    <div class="flex justify-around mb-6 bg-white p-2 rounded-full shadow-inner">
                        <button onclick="selectGoalCalculator('얼마를 모을까')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentGoalCalc === '얼마를 모을까' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">얼마를 모을까</button>
                        <button onclick="selectGoalCalculator('얼마를 넣을까')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentGoalCalc === '얼마를 넣을까' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">얼마를 넣을까</button>
                    </div>

                    <div id="goal-setting-form" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        </div>

                    <div id="goal-setting-result" class="p-5 rounded-xl text-center ${goalCalculationResult ? '' : 'hidden'} mb-6">
                         ${goalCalculationResult ? renderGoalSettingResult(goalCalculationResult) : ''}
                        </div>

                    <div class="mt-auto">
                        <button onclick="setAppState('PORTFOLIO')" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            추천 포트폴리오 보기
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Selects the goal calculator type and re-renders the form.
         * @param {string} type '얼마를 모을까' or '얼마를 넣을까'.
         */
        function selectGoalCalculator(type) {
            // '얼마를 넣을까'는 목표 금액을 위해 필요한 월 납입액 계산 (준비 중인 기능)
            // '얼마를 모을까'는 월 납입액으로 모을 수 있는 목표 금액 계산 (기존 기능 유지)
            sessionStorage.setItem('currentGoalCalc', type);
            // 결과를 숨김 처리하여 새로운 계산을 유도
            const resultDiv = document.getElementById('goal-setting-result');
            if(resultDiv) resultDiv.classList.add('hidden');
            renderApp();
        }

        /**
         * Renders the dynamic goal setting form.
         * @param {string} currentGoalCalc '얼마를 모을까' or '얼마를 넣을까'.
         */
        function renderGoalSettingForm(currentGoalCalc) {
            const formDiv = document.getElementById('goal-setting-form');
            if (!formDiv) return;
            
            let formHtml = '';

            if (currentGoalCalc === '얼마를 모을까') {
                // Default values for better UX
                const defaultMonths = 36;
                const defaultMonthly = 300000;

                formHtml = `
                    <h3 class="text-lg font-bold text-hyu-orange mb-4">현재의 저축 계획으로 예상되는 미래 금액은?</h3>
                    <div class="p-4 bg-white rounded-lg shadow space-y-4">
                        <label class="block mb-2 text-sm font-semibold">저축 기간 (개월)</label>
                        <input type="number" id="goal-input-months" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultMonths}">
                        <label class="block mb-2 text-sm font-semibold">매월 납입액 (원)</label>
                        <input type="number" id="goal-input-monthly" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultMonthly}">
                        <button onclick="calculateGoal('모을까')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                            예상 금액 확인하기
                        </button>
                    </div>
                `;
            } else if (currentGoalCalc === '얼마를 넣을까') {
                // Default values for better UX
                const defaultMonths = 36;
                const defaultGoal = 10000000;

                 formHtml = `
                    <h3 class="text-lg font-bold text-hyu-orange mb-4">목표 금액을 위해 얼마를 저축해야 할까요?</h3>
                    <div class="p-4 bg-white rounded-lg shadow space-y-4">
                        <label class="block mb-2 text-sm font-semibold">저축 기간 (개월)</label>
                        <input type="number" id="goal-input-months-target" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultMonths}">
                        <label class="block mb-2 text-sm font-semibold">목표 금액 (원)</label>
                        <input type="number" id="goal-input-target" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultGoal}">
                        <button onclick="calculateGoal('넣을까')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                            필요 납입액 확인하기
                        </button>
                    </div>
                `;
            }

            formDiv.innerHTML = formHtml;
        }

        /**
        * Helper function to calculate Future Value of Annuity Due.
        * Assumes monthly contribution at the start of the month.
        */
        function calculateFV(monthly, months, annualRate) {
            const monthlyRate = annualRate / 12;
            let futureValue = 0;
            if (monthlyRate === 0) {
                 return monthly * months;
            }
            // Future Value of Annuity Due: FV = P * [((1+r)^n - 1) / r] * (1+r)
            // But we use a simpler loop for better clarity and to handle potential floating point issues in the simplified context.
             for (let i = 0; i < months; i++) {
                // Contributions at the start of the month, compounds for one more period
                futureValue += monthly * Math.pow(1 + monthlyRate, months - i);
            }
            return futureValue;
        }

        /**
        * Calculates the goal scenario results (for '얼마를 모을까' - Predict Future Value).
        * OR Calculates the required monthly payment (for '얼마를 넣을까' - Predict Monthly Payment).
        * @param {string} mode '모을까' or '넣을까'.
        */
        function calculateGoal(mode) {
            const resultDiv = document.getElementById('goal-setting-result');
            let resultHtml = '';
            goalCalculationResult = null; // Reset previous result

            try {
                if (mode === '모을까') {
                    // (얼마를 모을까) - 월 납입액으로 예상되는 미래 금액 계산
                    const monthly = parseFloat(document.getElementById('goal-input-monthly').value);
                    const months = parseInt(document.getElementById('goal-input-months').value);

                    if (monthly <= 0 || months <= 0 || isNaN(monthly) || isNaN(months)) throw new Error("유효하지 않은 입력값입니다.");
                    
                    const principal = monthly * months;
                    const results = {};

                    // CASE 1: 국내 배당주 ETF (Simulate Installment Savings - Simple Interest, as per original logic for 3% saving)
                    const itemSavings = currentPortfolio.find(p => p.name.includes("국내 배당주"));
                    // **수정 시작: NaN 방지를 위해 유효성 검사 및 기본값 설정**
                    const rateSavings = itemSavings && !isNaN(itemSavings.rate) ? itemSavings.rate : 0.03;
                    // **수정 끝**
                    
                    let interestSavings = 0;
                    for (let i = 1; i <= months; i++) {
                        // Simple interest on each monthly deposit: P * R * (T/12)
                        interestSavings += monthly * rateSavings * ((months - i + 1) / 12);
                    }
                    // **수정: 이름에서 수익률 제거**
                    results.case1 = { name: 'CASE 1. 국내 배당주 ETF', rate: rateSavings, amount: principal + interestSavings, color: 'border-hyu-green' };

                    // CASE 2: 미국 테크주 인덱스 (Compound Interest - Annual Rate)
                    const itemNasdaq = currentPortfolio.find(p => p.name.includes("미국 테크주"));
                    // **수정 시작: NaN 방지를 위해 유효성 검사 및 기본값 설정**
                    const rateNasdaq = itemNasdaq && !isNaN(itemNasdaq.rate) ? itemNasdaq.rate : 0.10;
                    // **수정 끝**
                    // **수정: 이름에서 수익률 제거**
                    results.case2 = { name: 'CASE 2. 미국 테크주 인덱스', rate: rateNasdaq, amount: calculateFV(monthly, months, rateNasdaq), color: 'border-hyu-orange' };

                    // CASE 3: 금/원자재 펀드 (Compound Interest - Annual Rate)
                    const itemGold = currentPortfolio.find(p => p.name.includes("금/원자재"));
                    // **수정 시작: NaN 방지를 위해 유효성 검사 및 기본값 설정**
                    const rateGold = itemGold && !isNaN(itemGold.rate) ? itemGold.rate : 0.07;
                    // **수정 끝**
                    // **수정: 이름에서 수익률 제거**
                    results.case3 = { name: 'CASE 3. 금/원자재 펀드', rate: rateGold, amount: calculateFV(monthly, months, rateGold), color: 'border-hyu-gold' };

                    goalCalculationResult = { mode: '모을까', monthly: monthly, months: months, principal: principal, results: results };
                    resultHtml = renderGoalSettingResult(goalCalculationResult);
                    
                } else if (mode === '넣을까') {
                    // (얼마를 넣을까) - 목표 금액을 위해 필요한 월 납입액 계산
                    const months = parseInt(document.getElementById('goal-input-months-target').value);
                    const targetAmount = parseFloat(document.getElementById('goal-input-target').value);

                    if (targetAmount <= 0 || months <= 0 || isNaN(targetAmount) || isNaN(months)) throw new Error("유효하지 않은 입력값입니다.");

                    // CASE 1: 국내 배당주 ETF (Simple Interest - Monthly Basis, for comparison)
                    const itemSavings = currentPortfolio.find(p => p.name.includes("국내 배당주"));
                    const rateSavings = itemSavings && !isNaN(itemSavings.rate) ? itemSavings.rate : 0.03; // **수정: NaN 방지**
                    // 필요한 월 납입액 (P*N + I) = T.  I = P * R/12 * (N*(N+1)/2)
                    // P * (N + R/12 * N*(N+1)/2) = T
                    const savingsFactor = months + rateSavings / 12 * (months * (months + 1) / 2);
                    const monthlySavings = targetAmount / savingsFactor;

                    // CASE 2: 미국 테크주 인덱스 (Compound Interest - Annuity Due)
                    const itemNasdaq = currentPortfolio.find(p => p.name.includes("미국 테크주"));
                    const rateNasdaq = itemNasdaq && !isNaN(itemNasdaq.rate) ? itemNasdaq.rate : 0.10; // **수정: NaN 방지**
                    const monthlyRateNasdaq = rateNasdaq / 12;
                    // Annuity Due: FV = P * [((1+r)^n - 1) / r] * (1+r)
                    const compoundFactorNasdaq = ((Math.pow(1 + monthlyRateNasdaq, months) - 1) / monthlyRateNasdaq) * (1 + monthlyRateNasdaq);
                    const monthlyNasdaq = targetAmount / compoundFactorNasdaq;

                    // CASE 3: 금/원자재 펀드 (Compound Interest - Annuity Due)
                    const itemGold = currentPortfolio.find(p => p.name.includes("금/원자재"));
                    const rateGold = itemGold && !isNaN(itemGold.rate) ? itemGold.rate : 0.07; // **수정: NaN 방지**
                    const monthlyRateGold = rateGold / 12;
                    const compoundFactorGold = ((Math.pow(1 + monthlyRateGold, months) - 1) / monthlyRateGold) * (1 + monthlyRateGold);
                    const monthlyGold = targetAmount / compoundFactorGold;
                    
                    const results = {
                         // **수정: 이름에서 수익률 제거**
                         case1: { name: 'CASE 1. 국내 배당주 ETF', rate: rateSavings, amount: monthlySavings, color: 'border-hyu-green' },
                         case2: { name: 'CASE 2. 미국 테크주 인덱스', rate: rateNasdaq, amount: monthlyNasdaq, color: 'border-hyu-orange' },
                         case3: { name: 'CASE 3. 금/원자재 펀드', rate: rateGold, amount: monthlyGold, color: 'border-hyu-gold' }
                    };

                    goalCalculationResult = { mode: '넣을까', targetAmount: targetAmount, months: months, results: results };
                    resultHtml = renderGoalSettingResult(goalCalculationResult);
                }

                resultDiv.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Goal Calculation Error:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">입력값을 올바르게 입력해주세요.</p>`;
                resultDiv.classList.remove('hidden');
            }
        }


        /**
         * Renders the result section for Goal Setting.
         */
        function renderGoalSettingResult(data) {
             const createCaseBox = (name, rate, amount, color) => `
                <div class="p-4 rounded-xl border-l-4 ${color} bg-white">
                    <p class="font-semibold text-gray-800 mb-2">${name}</p>
                    <div class="text-sm text-gray-600 space-y-1">
                        ${data.mode === '모을까' 
                            // **수정: 예상 수익률 출력 포맷 개선**
                            ? `<span>예상 수익률: ${Math.round(rate * 100)}%</span><span class="block font-bold text-base text-hyu-blue">만기 예상 금액: ${Math.round(amount).toLocaleString()} 원</span>` 
                            : `<span>예상 수익률: ${Math.round(rate * 100)}%</span><span class="block font-bold text-base text-hyu-blue">필요 월 납입액: ${Math.round(amount).toLocaleString()} 원</span>`
                        }
                    </div>
                </div>
            `;
            
            let titleText = '';
            if (data.mode === '모을까') {
                titleText = `🎉 예상금액 확인 결과 (원금: ${data.principal.toLocaleString()}원)`;
            } else if (data.mode === '넣을까') {
                titleText = `💰 목표 금액 달성 계획 (목표: ${data.targetAmount.toLocaleString()}원 / 기간: ${data.months}개월)`;
            }

            return `
                <div class="text-left">
                    <p class="text-lg font-bold mb-4">
                        <span class="text-hyu-orange">${titleText}</span>
                    </p>
                    <div class="space-y-3">
                        ${createCaseBox(data.results.case1.name, data.results.case1.rate, data.results.case1.amount, data.results.case1.color)}
                        ${createCaseBox(data.results.case2.name, data.results.case2.rate, data.results.case2.amount, data.results.case2.color)}
                        ${createCaseBox(data.results.case3.name, data.results.case3.rate, data.results.case3.amount, data.results.case3.color)}
                    </div>
                    <p class="text-xs text-gray-500 mt-4"> * 예상 금액은 과거 수익률을 단순 적용한 결과이며, 미래 수익을 보장하지 않습니다. </p>
                </div>
            `;
        }


        // #007 포트폴리오 추천 (기존 #007에서 번호 변경 및 수정)
        function renderPortfolio() {
             // Utility function to get tailwind color class name from mock color name
            const getColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'text-hyu-green';
                    case 'hyu-orange': return 'text-hyu-orange';
                    case 'hyu-gold': return 'text-hyu-gold';
                    default: return 'text-gray-500';
                }
            };
            
            // Utility function for border color
            const getBorderColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'border-hyu-green';
                    case 'hyu-orange': return 'border-hyu-orange';
                    case 'hyu-gold': return 'border-hyu-gold';
                    default: return 'border-gray-500';
                }
            };
            
            // Calculate pie chart colors and stops
            let currentStop = 0;
            const conicStops = currentPortfolio.map(item => {
                const start = currentStop;
                currentStop += item.percentage;
                // Use hex codes for background conic-gradient
                const hexColor = item.color.replace('hyu-blue', '#0E4A84').replace('hyu-green', '#7DB928').replace('hyu-orange', '#F08100').replace('hyu-gold', '#88774F');
                return `${hexColor} ${start}% ${currentStop}%`;
            }).join(', ');
            
            // Calculate total portfolio value if goal data is available
            let totalPortfolioValueHtml = '';
            let totalPortfolioValue = 0;

            // **수정 시작: NaN 오류 및 색상 변경 반영**
            if (goalCalculationResult && goalCalculationResult.mode === '모을까') {
                const results = goalCalculationResult.results;
                
                // Get the final amounts from the calculation result
                const case1Amount = results.case1.amount;
                const case2Amount = results.case2.amount;
                const case3Amount = results.case3.amount;

                // Map final amounts to portfolio items based on name (a bit fragile, but works for this mock)
                const item1 = currentPortfolio.find(p => p.name.includes("국내 배당주"));
                const item2 = currentPortfolio.find(p => p.name.includes("미국 테크주"));
                const item3 = currentPortfolio.find(p => p.name.includes("금/원자재"));

                // Calculate weighted total value
                totalPortfolioValue = 
                    (case1Amount * (item1.percentage / 100)) +
                    (case2Amount * (item2.percentage / 100)) +
                    (case3Amount * (item3.percentage / 100));

                // NaN 방지 및 포맷팅
                const displayAmount = isNaN(totalPortfolioValue) || totalPortfolioValue <= 0 ? '목표 설정 필요' : Math.round(totalPortfolioValue).toLocaleString();
                
                // 1. 글씨색 text-hyu-blue 적용, 2. 배경 및 border 스타일 변경
                totalPortfolioValueHtml = `
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg text-center shadow-md border-b-4 border-hyu-blue">
                        <p class="text-sm text-gray-700">현재 포트폴리오 비중 적용 예상 만기 금액</p>
                        <p class="text-xl font-extrabold text-hyu-blue mt-1">${displayAmount} 원</p> 
                    </div>
                `;
            } else {
                 // 목표 금액 설정이 안 된 경우 안내 메시지 출력
                totalPortfolioValueHtml = `
                    <div class="mt-4 p-3 bg-red-50 border border-red-200 text-center rounded-lg shadow-md">
                        <p class="text-sm font-semibold text-red-600">⚠️ 목표 금액 설정이 필요합니다.</p>
                        <p class="text-xs text-red-500 mt-1">이전 페이지에서 '얼마를 모을까' 탭의 '예상 금액 확인하기' 버튼을 눌러주세요.</p>
                    </div>
                `;
            }
            // **수정 끝**


            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">포트폴리오 추천</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <p class="text-lg font-semibold mb-4 text-center">나의 투자 성향 분석 결과: <span class="text-hyu-orange">공격 투자형</span></p>
                        <p class="text-sm text-gray-600 mb-6 text-center">
                            * 포트폴리오 추천은 단순 예시이며, 실제 투자는 개인의 책임 하에 이루어져야 합니다.
                        </p>

                        <div class="w-full flex justify-center mb-6">
                            <div class="w-36 h-36 rounded-full relative" style="background: conic-gradient(${conicStops}); box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                                <div class="absolute inset-4 bg-white rounded-full flex items-center justify-center">
                                    <span class="text-2xl font-bold text-hyu-blue">100%</span>
                                </div>
                            </div>
                        </div>

                        ${totalPortfolioValueHtml} 

                        <div class="space-y-4 mb-6 mt-4">
                            ${currentPortfolio.map(item => `
                                <div class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 ${getBorderColorClass(item.color)}">
                                    <i class="fa-solid ${item.icon} text-xl w-6 ${getColorClass(item.color)}"></i>
                                    <div class="ml-4 flex-grow">
                                        <div class="flex justify-between items-center">
                                            <span class="font-semibold text-gray-800">${item.name}</span>
                                            <span class="font-bold text-lg ${getColorClass(item.color)}">${item.percentage}%</span>
                                        </div>
                                        <p class="text-xs text-gray-500">${item.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="setAppState('PORTFOLIO_EDIT')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg shadow-md hover:opacity-90 transition">
                            포트폴리오 구성 비중 수정하기
                        </button>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">포트폴리오 추천 참고 사항</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>자세한 투자 비중은 개인의 상황에 맞게 조정해야 합니다.</li>
                            <li>해당 포트폴리오는 시장 상황에 따라 손실이 발생할 수 있습니다.</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // --- #007-1 포트폴리오 비중 수정 (새로 추가) ---
        function renderPortfolioEdit() {
            window.savePortfolio = savePortfolio;

            // Utility function to get tailwind color class name from mock color name
            const getColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'text-hyu-green';
                    case 'hyu-orange': return 'text-hyu-orange';
                    case 'hyu-gold': return 'text-hyu-gold';
                    default: return 'text-gray-500';
                }
            };
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">포트폴리오 비중 수정</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <p class="text-sm text-gray-600 mb-4 font-semibold text-center">
                            각 자산의 비중을 수정하고, 합계가 <span class="text-hyu-orange">100%</span>가 되도록 맞춰주세요.
                        </p>

                        <div id="portfolio-edit-list" class="space-y-4 mb-4">
                            ${currentPortfolio.map((item, index) => `
                                <div class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-hyu-blue">
                                    <i class="fa-solid ${item.icon} text-xl w-6 ${getColorClass(item.color)}"></i>
                                    <div class="ml-4 flex-grow">
                                        <span class="font-semibold text-gray-800">${item.name}</span>
                                    </div>
                                    <input type="number" 
                                           data-index="${index}" 
                                           id="edit-percentage-${index}" 
                                           class="w-20 p-2 border text-right rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" 
                                           value="${item.percentage}" 
                                           min="0" max="100"
                                           oninput="checkPortfolioTotal()">
                                    <span class="ml-2 text-lg font-bold">%</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-between items-center p-3 border-t-2 border-hyu-blue mt-4">
                            <span class="text-lg font-bold text-gray-800">총합계</span>
                            <span id="portfolio-total" class="text-2xl font-extrabold text-hyu-orange">100%</span>
                        </div>
                        
                        <button onclick="savePortfolio()" id="save-portfolio-btn" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition mt-6">
                            비중 저장하기
                        </button>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">주의 사항</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>총합계가 100%가 되지 않으면 저장이 불가능합니다.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Checks the total percentage of the portfolio during editing.
         */
        window.checkPortfolioTotal = function() {
            const inputs = document.querySelectorAll('#portfolio-edit-list input');
            let total = 0;
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });

            const totalSpan = document.getElementById('portfolio-total');
            const saveBtn = document.getElementById('save-portfolio-btn');

            totalSpan.textContent = `${total}%`;
            
            if (total === 100) {
                totalSpan.classList.remove('text-red-500');
                totalSpan.classList.add('text-hyu-orange');
                saveBtn.disabled = false;
                saveBtn.classList.remove('hyu-silver');
                saveBtn.classList.add('hyu-blue');
            } else {
                totalSpan.classList.remove('text-hyu-orange');
                totalSpan.classList.add('text-red-500');
                saveBtn.disabled = true;
                saveBtn.classList.remove('hyu-blue');
                saveBtn.classList.add('hyu-silver');
            }
        };
        
        /**
         * Saves the updated portfolio percentages.
         */
        function savePortfolio() {
            const inputs = document.querySelectorAll('#portfolio-edit-list input');
            let total = 0;
            const newPortfolio = [];

            inputs.forEach(input => {
                const percentage = parseInt(input.value) || 0;
                total += percentage;
                const index = parseInt(input.getAttribute('data-index'));
                
                // Deep copy and update
                newPortfolio.push({
                    ...currentPortfolio[index],
                    percentage: percentage
                });
            });

            if (total !== 100) {
                showMessage("총합계가 100%가 되어야 저장이 가능합니다. 현재 합계: " + total + "%");
                return;
            }

            currentPortfolio = newPortfolio;
            localStorage.setItem('hyufa_portfolio', JSON.stringify(currentPortfolio));
            showMessage("포트폴리오 비중이 성공적으로 저장되었습니다!");
            setAppState('PORTFOLIO'); // Return to the portfolio view
        }


        // #008 금융 계산기 (기존 #008에서 번호 변경)
        function renderCalculator() {
            // Expose utility functions to global scope
            window.selectCalculator = selectCalculator;
            window.calculateFinance = calculateFinance;

            // Simple state for calculator type
            const currentCalc = sessionStorage.getItem('currentCalc') || '적금';
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">금융 계산기</h2>
                    
                    <div class="flex justify-around mb-6 bg-white p-2 rounded-full shadow-inner">
                        <button onclick="selectCalculator('적금')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === '적금' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">적금</button>
                        <button onclick="selectCalculator('예금')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === '예금' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">예금</button>
                        <button onclick="selectCalculator('대출')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === '대출' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">대출</button>
                    </div>

                    <div id="calculator-form" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        </div>

                    <div id="calculator-result" class="p-5 bg-white rounded-xl shadow-inner text-center hidden mb-6">
                        </div>

                    <div class="mt-auto p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">계산기 이용 유의 사항</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>세금(이자소득세 15.4%)은 계산에 포함되지 않았습니다.</li>
                            <li>실제 금융 상품의 약관에 따라 결과와 차이가 있을 수 있습니다.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Selects the calculator type and re-renders the form.
         * @param {string} type '적금', '예금', or '대출'.
         */
        function selectCalculator(type) {
            sessionStorage.setItem('currentCalc', type);
            renderApp(); // Re-render to update nav and form
        }

        /**
         * Renders the dynamic calculator form.
         * @param {string} currentCalc '적금', '예금', or '대출'.
         */
        function renderCalculatorForm(currentCalc) { // <--- 계산기 오류 수정 부분 (2/2)
            const formDiv = document.getElementById('calculator-form');
            if (!formDiv) return;
            
            let title = '';
            let formHtml = '';

            switch (currentCalc) {
                case '적금':
                    title = '적금 (자유 적립식 - 단순 합계)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">매월 납입액 (원)</label>
                        <input type="number" id="input-monthly" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="100000">
                        <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                        <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">
                        <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                        <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.0">
                    `;
                    break;
                case '예금':
                    title = '예금 (단리 - 만기 지급)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">예금 원금 (원)</label>
                        <input type="number" id="input-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="1000000">
                        <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                        <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">
                        <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                        <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.0">
                    `;
                    break;
                case '대출':
                    title = '대출 (원리금 균등 상환)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">대출 원금 (원)</label>
                        <input type="number" id="input-loan-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="10000000">
                        <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                        <input type="number" id="input-loan-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="36">
                        <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                        <input type="number" step="0.1" id="input-loan-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="5.5">
                    `;
                    break;
            }

            formDiv.innerHTML = `
                <h3 class="text-lg font-bold text-hyu-orange mb-4">${title}</h3>
                <div class="p-4 bg-white rounded-lg shadow space-y-3">
                    ${formHtml}
                    <button onclick="calculateFinance('${currentCalc}')" class="w-full hyu-blue text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                        결과 계산하기
                    </button>
                </div>
            `;
        }

        /**
         * Calculates the financial result based on the current calculator form.
         * @param {string} currentCalc '적금', '예금', or '대출'.
         */
        function calculateFinance(currentCalc) {
            const resultDiv = document.getElementById('calculator-result');
            let resultHtml = '';

            try {
                let totalInterest = 0;
                let totalAmount = 0;

                switch (currentCalc) {
                    case '적금': // Installment Savings (Simple Interest - Monthly Basis)
                        const monthly = parseFloat(document.getElementById('input-monthly').value);
                        const months = parseInt(document.getElementById('input-months').value);
                        const rate = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (monthly <= 0 || months <= 0 || rate < 0 || isNaN(monthly) || isNaN(months) || isNaN(rate)) throw new Error("유효하지 않은 입력값입니다.");

                        // Total Principal
                        const principal = monthly * months;

                        // Calculate total interest using simple sum of monthly interest (sum of 1 to N months)
                        for (let i = 1; i <= months; i++) {
                            // Monthly principal * Annual Rate * (i / 12)
                            totalInterest += monthly * rate * ((months - i + 1) / 12);
                        }

                        totalAmount = principal + totalInterest;

                        // 수정: toLocaleString() 적용하여 금액에 쉼표(,) 구분자 추가
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">총 수령액: ${Math.round(totalAmount).toLocaleString()} 원</p>
                            <p class="text-sm font-semibold text-gray-700">원금 합계: ${Math.round(principal).toLocaleString()} 원</p>
                            <p class="text-sm text-hyu-green">세전 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                        `;
                        break;
                    case '예금': // Fixed Deposit (Simple Interest - Annual Basis)
                        const principalE = parseFloat(document.getElementById('input-principal').value);
                        const monthsE = parseInt(document.getElementById('input-months').value);
                        const rateE = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (principalE <= 0 || monthsE <= 0 || rateE < 0 || isNaN(principalE) || isNaN(monthsE) || isNaN(rateE)) throw new Error("유효하지 않은 입력값입니다.");

                        totalInterest = principalE * rateE * (monthsE / 12);
                        totalAmount = principalE + totalInterest;

                        // 수정: toLocaleString() 적용하여 금액에 쉼표(,) 구분자 추가
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">만기 수령액: ${Math.round(totalAmount).toLocaleString()} 원</p>
                            <p class="text-sm font-semibold text-gray-700">원금: ${Math.round(principalE).toLocaleString()} 원</p>
                            <p class="text-sm text-hyu-green">세전 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                        `;
                        break;
                    case '대출': // Loan (Equal Principal and Interest Payment - Monthly)
                        const principalL = parseFloat(document.getElementById('input-loan-principal').value);
                        const monthsL = parseInt(document.getElementById('input-loan-months').value);
                        const rateL = parseFloat(document.getElementById('input-loan-rate').value) / 100;

                        if (principalL <= 0 || monthsL <= 0 || rateL < 0 || isNaN(principalL) || isNaN(monthsL) || isNaN(rateL)) throw new Error("유효하지 않은 입력값입니다.");

                        const monthlyRate = rateL / 12;

                        if (monthlyRate === 0) {
                            // No interest
                            const monthlyPaymentNoInterest = principalL / monthsL;
                            totalInterest = 0;
                            resultHtml = `
                                <p class="text-xl font-bold text-hyu-blue mb-2">매월 상환액: ${Math.round(monthlyPaymentNoInterest).toLocaleString()} 원</p>
                                <p class="text-sm font-semibold text-gray-700">대출 원금: ${principalL.toLocaleString()} 원</p>
                                <p class="text-sm text-hyu-green">총 이자: 0 원</p>
                            `;
                        } else {
                            // 원리금 균등 상환 공식
                            const power = Math.pow(1 + monthlyRate, monthsL);
                            const monthlyPayment = principalL * (monthlyRate * power) / (power - 1);
                            
                            totalAmount = monthlyPayment * monthsL;
                            totalInterest = totalAmount - principalL;
                            
                            resultHtml = `
                                <p class="text-xl font-bold text-hyu-blue mb-2">매월 상환액: ${Math.round(monthlyPayment).toLocaleString()} 원</p>
                                <p class="text-sm font-semibold text-gray-700">총 상환액: ${Math.round(totalAmount).toLocaleString()} 원</p>
                                <p class="text-sm text-hyu-green">총 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                            `;
                        }
                        break;
                }

                resultDiv.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Calculation Error:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">입력값을 확인해주세요.</p>`;
                resultDiv.classList.remove('hidden');
            }
        }

        // #009 HYUFA 고객센터
        function renderCustomerCenter() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 고객센터</h2>

                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">자주 하는 질문으로 이동</h3>
                        <p class="text-sm text-gray-600 mb-4">많은 이용자들이 궁금해하는 질문은 FAQ에서 빠르게 확인하실 수 있습니다.</p>
                        <button onclick="setAppState('FAQ')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg shadow-md hover:opacity-90 transition">
                            <i class="fa-solid fa-circle-question mr-2"></i> FAQ 바로가기
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">전화 상담 안내</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            금융 상담이 필요하신 경우, 평일 업무 시간 내에 연락주시면 전문 상담원을 연결해 드립니다.
                        </p>
                        <div class="flex items-center justify-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fa-solid fa-phone-volume text-3xl text-hyu-blue mr-4"></i>
                            <a href="tel:02-2220-0000" class="text-2xl font-bold text-hyu-blue hover:text-hyu-orange transition">
                                02-2220-0000
                            </a>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            * 본 전화번호는 한양대학교 대표 전화번호를 가정한 임시 번호입니다.
                        </p>
                    </div>
                </div>
            `;
        }

        // #0010 HYUFA 의견 남기기
        function renderFeedback() {
            // Expose submitFeedback to global scope
            window.submitFeedback = submitFeedback;
            window.setRating = setRating;
            
            let currentRating = 0;

            // Rating logic inside the component to manage state better
            function setRating(rating) {
                currentRating = rating;
                document.querySelectorAll('#rating-stars i').forEach((star) => {
                    const starRating = parseInt(star.getAttribute('data-rating'));
                    if (starRating <= rating) {
                        star.style.color = '#88774F'; // HYU Gold
                    } else {
                        star.style.color = '#ccc';
                    }
                });
            }

            async function submitFeedback() {
                const text = document.getElementById('feedback-text').value.trim();
                
                if (currentRating === 0 || text === '') {
                    showMessage("별점과 의견을 모두 입력해주세요.");
                    return;
                }

                try {
                    const feedbackData = {
                        userId: userId,
                        rating: currentRating,
                        feedback: text,
                        timestamp: serverTimestamp() 
                    };

                    // Assuming 'artifacts' is a top-level collection and we store public data inside it
                    const feedbackRef = collection(db, 'artifacts', appId, 'public', 'data', 'feedback');
                    await addDoc(feedbackRef, feedbackData);

                    showMessage("소중한 의견이 제출되었습니다. 감사합니다!");
                    setAppState('MAIN_CHAT');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("의견 제출에 실패했습니다. (Error: " + e.code + ")");
                }
            }
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 의견 남기기</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">소중한 의견으로 똑똑한 HYUFA가 되겠습니다.</h3>

                        <div id="rating-stars" class="flex justify-center text-4xl text-gray-300 space-x-1 mb-6">
                            ${[1, 2, 3, 4, 5].map(i => `
                                <i class="fa-solid fa-star cursor-pointer hover:text-hyu-gold transition duration-150" data-rating="${i}" onclick="setRating(${i})"></i>
                            `).join('')}
                        </div>

                        <textarea id="feedback-text" rows="5" placeholder="HYUFA에게 바라는 점, 개선할 점 등 자유롭게 의견을 남겨주세요." class="w-full p-4 border border-gray-300 rounded-lg focus:ring-hyu-blue focus:border-hyu-blue mb-6 resize-none"></textarea>

                        <button onclick="submitFeedback()" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            의견 제출하기
                        </button>
                    </div>
                </div>
            `;
        }


        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <i class="fa-solid fa-circle-notch fa-spin text-5xl text-hyu-blue mb-4"></i>
                    <p class="text-xl font-semibold text-gray-700">서비스를 준비 중입니다...</p>
                    <p class="text-sm text-hyu-silver mt-2">잠시만 기다려주세요.</p>
                </div>
            `;
        }

        // --- 6. Initialization ---

        window.onload = async () => {
            // 1) FAQ 데이터 로드
            await loadFAQData();

            // 2) 기대수익률 JSON 로드해서 currentPortfolio.rate 업데이트
            await loadExpectedReturns();
            console.log("최종 currentPortfolio", currentPortfolio); 

            // 3) Firebase 초기화
            await initializeFirebase();

            // 4) 포트폴리오 편집 화면이면 총합계 표시
            if (appState === 'PORTFOLIO_EDIT') {
                checkPortfolioTotal();
            }
        };

        // Expose top-level functions to global scope for HTML onclick
        window.setAppState = setAppState;
        window.handleConsent = handleConsent;
        window.renderCalculatorForm = renderCalculatorForm; // Expose for calculator logic
        window.renderGoalSettingForm = renderGoalSettingForm; // Expose for goal setting logic
        
    </script>
</body>
</html>
