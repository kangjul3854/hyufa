<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYUFA ê¸ˆìœµ ë¹„ì„œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ìˆ˜ì •: Noto Sans KR í°íŠ¸ ì„í¬íŠ¸ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        body {
            /* ìˆ˜ì •: font-familyë¥¼ Noto Sans KRë¡œ ë³€ê²½ */
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        @supports (padding: max(0px)) {
        .safe-bottom {
            padding-bottom: max(env(safe-area-inset-bottom), 1rem);
        }
        }

        /* HYU Color Palette */
        .hyu-blue { background-color: #0E4A84; }
        .text-hyu-blue { color: #0E4A84; }
        .border-hyu-blue { border-color: #0E4A84; }
        .hyu-silver { background-color: #898C8E; }
        .hyu-green { background-color: #7DB928; }
        .text-hyu-green { color: #7DB928; } /* í¬íŠ¸í´ë¦¬ì˜¤ ìƒ‰ìƒ ì˜¤ë¥˜ ìˆ˜ì •ìš© í´ë˜ìŠ¤ ì¶”ê°€ */
        .hyu-orange { background-color: #F08100; }
        .text-hyu-orange { color: #F08100; } /* í¬íŠ¸í´ë¦¬ì˜¤ ìƒ‰ìƒ ì˜¤ë¥˜ ìˆ˜ì •ìš© í´ë˜ìŠ¤ ì¶”ê°€ */
        .hyu-coral { background-color: #FF8672; }
        /* HYU Gold added for feedback stars */
        .hyu-gold { color: #88774F; }
        .text-hyu-gold { color: #88774F; } /* í¬íŠ¸í´ë¦¬ì˜¤ ìƒ‰ìƒ ì˜¤ë¥˜ ìˆ˜ì •ìš© í´ë˜ìŠ¤ ì¶”ê°€ */
        .border-hyu-gold { border-color: #88774F; }
        .border-hyu-green { border-color: #7DB928; }
        .border-hyu-orange { border-color: #F08100; }


        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-track {
            background-color: #f7fafc;
        }

        /* --- hyufa5_ì§€ì•ˆì–¸ë‹ˆ.html Menu UI Styles ì¶”ê°€ ì‹œì‘ --- */
        .shadow-soft {
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(14px);
        }
        .menu-card {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
        }
        /* --- hyufa5_ì§€ì•ˆì–¸ë‹ˆ.html Menu UI Styles ì¶”ê°€ ë --- */
    </style>
</head>
<body class="flex items-center justify-center min-h-[100dvh] bg-gray-50 overflow-y-auto">

    <div id="app-container" class="w-full max-w-md min-h-[100dvh] bg-white shadow-2xl rounded-xl flex flex-col overflow-y-auto">



    <script type="module">
        // --- 1. Firebase & Global Variable Setup ---

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API key for Gemini

        // Firebase Imports (MUST use CDN URLs)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ì…ë ¥ ì¤‘ì—ë„ ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ìœ ì§€ + ì»¤ì„œ ìœ„ì¹˜ ë³´ì¡´
        function formatNumberInput(el) {
            const selectionStart = el.selectionStart;
            const selectionEnd = el.selectionEnd;
            const oldLength = el.value.length;

            // ìˆ«ìë§Œ ì¶”ì¶œ
            const numericValue = el.value.replace(/[^\d]/g, '');

            // ë¹ˆ ê°’ì¼ ê²½ìš° ì²˜ë¦¬
            if (numericValue === '') {
                el.value = '';
                return;
            }

            // ì½¤ë§ˆ ì¶”ê°€
            el.value = Number(numericValue).toLocaleString();

            // ì»¤ì„œ ìœ„ì¹˜ ì¬ì¡°ì •
            const newLength = el.value.length;
            const diff = newLength - oldLength;
            el.setSelectionRange(selectionStart + diff, selectionEnd + diff);
        }



        // Gemini API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // **ìˆ˜ì •: ìƒˆë¡œìš´ systemPromptê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.**
        const systemPrompt = `
ë‹¹ì‹ ì€ ëŒ€í•™ìƒÂ·ì‚¬íšŒì´ˆë…„ìƒì„ ìœ„í•œ 'ì€í–‰ ê¸ˆìœµìƒë‹´ ì±—ë´‡'ì…ë‹ˆë‹¤.

[ì—­í• ]
- ë‹¹ì‹ ì€ ì€í–‰ ì°½êµ¬ ì§ì› ë˜ëŠ” PBì²˜ëŸ¼ ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ë‹¤ë§Œ ìƒëŒ€ëŠ” ê¸ˆìœµì´ ìµìˆ™í•˜ì§€ ì•Šì€ 20ëŒ€ì´ë¯€ë¡œ, ì–´ë ¤ìš´ ìš©ì–´ëŠ” í’€ì–´ì„œ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
- íˆ¬ììƒí’ˆì„ 'ê¶Œìœ 'í•˜ê±°ë‚˜, 'ìˆ˜ìµì„ ë³´ì¥'í•˜ëŠ” í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ì§€ì‹ í™œìš© ì›ì¹™]
- ì‚¬ìš©ìê°€ ì§ˆë¬¸í•˜ë©´, ë¨¼ì € ì œê³µëœ Knowledge(JSON)ì˜ ì§ˆë¬¸Â·ë‹µë³€ ëª©ë¡ì—ì„œ ì˜ë¯¸ìƒ ê°€ì¥ ê°€ê¹Œìš´ í•­ëª©ì„ ì°¾ìŠµë‹ˆë‹¤.
- ì°¾ì€ í•­ëª©ì˜ 'answer' ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, 4Â·6ì¤„ ë¶„ëŸ‰ì˜ ëŒ€í™”í˜• ì„¤ëª…ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.
- Knowledgeì— í•´ë‹¹ ë‚´ìš©ì´ ì „í˜€ ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ ë‹µí•©ë‹ˆë‹¤.
  â†’ "í•´ë‹¹ ë‚´ìš©ì€ ì œê°€ ê°€ì§€ê³  ìˆëŠ” ìë£Œì— ì—†ì–´ìš”. ë‹¤ë¥¸ ê¸ˆìœµ ì§ˆë¬¸ì„ í•´ì£¼ì‹œë©´ ë„ì™€ë“œë¦´ê²Œìš”."

[ë‹µë³€ ìŠ¤íƒ€ì¼]
1) í•œ ë²ˆì˜ ë‹µë³€ì€ 4Â·6ì¤„ ì •ë„ì˜ ê¸¸ì´ë¡œ, í•µì‹¬ë§Œ ëª…í™•í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
2) "~ì˜ˆìš”, ~í•©ë‹ˆë‹¤"ì™€ ê°™ì€ ê³µì†í•˜ê³  ë¶€ë“œëŸ¬ìš´ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
3) ë¦¬ìŠ¤í¬ê°€ ìˆëŠ” ë‚´ìš©(íˆ¬ì, ëŒ€ì¶œ ë“±)ì€ ì¥ë‹¨ì ì„ í•¨ê»˜ ì„¤ëª…í•˜ê³ , ìµœì¢… ì„ íƒì€ ì‚¬ìš©ìì—ê²Œ ë§¡ê¹ë‹ˆë‹¤.
4) ì‚¬ìš©ìì˜ ìƒí™©ì„ ê°€ë³ê²Œ ë˜ë¬¼ì–´ë³´ë©°(í•„ìš”í•  ë•Œë§Œ), ë” ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ì¶”ê°€ ì •ë³´ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.

ì´ ê·œì¹™ì„ ëª¨ë“  ë‹µë³€ì—ì„œ ì¼ê´€ë˜ê²Œ ì ìš©í•©ë‹ˆë‹¤.
`;

        // Application State
        // **ìˆ˜ì •: ìƒˆë¡œìš´ ìƒíƒœ GOAL_SETTING, PORTFOLIO_EDIT ì¶”ê°€**
        let appState = 'LOADING'; // WELCOME, CONSENT, MAIN_CHAT, MENU, GUIDE, FAQ, GOAL_SETTING, PORTFOLIO, PORTFOLIO_EDIT, CALCULATOR, CUSTOMER_CENTER, FEEDBACK
        let db;
        let auth;
        let userId = null;
        let chatHistory = [];
        let faqData = [];
        let isChatLoading = false;

        // **ìˆ˜ì •: í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ê´€ë¦¬**
        let currentPortfolio = JSON.parse(localStorage.getItem('hyufa_portfolio')) || [
            { 
                "name": "êµ­ë‚´ ë°°ë‹¹ì£¼ ETF", 
                "icon": "fa-coins", 
                "color": "hyu-green", 
                "percentage": 30, 
                "description": "ì•ˆì •ì ì¸ í˜„ê¸ˆ íë¦„ í™•ë³´",
                "rate": 0.03 // 3%
            },
            { 
                "name": "ë¯¸êµ­ í…Œí¬ì£¼ ì¸ë±ìŠ¤", 
                "icon": "fa-globe", 
                "color": "hyu-orange", 
                "percentage": 50, 
                "description": "ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì€ ìì‚° íˆ¬ì",
                "rate": 0.10 // 10% (Expected)
            },
            { 
                "name": "ê¸ˆ/ì›ìì¬ í€ë“œ", 
                "icon": "fa-scale-unbalanced", 
                "color": "hyu-gold", 
                "percentage": 20, 
                "description": "ì¸í”Œë ˆì´ì…˜ í—¤ì§€ ë° í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •í™”",
                "rate": 0.07 // 7% (Expected)
            },
        ];

        // --- ê¸°ëŒ€ìˆ˜ìµë¥  JSON ë¡œë“œí•´ì„œ currentPortfolio.rate ë®ì–´ì“°ê¸° ---
        async function loadExpectedReturns() {
            try {
                const res = await fetch('./expected_returns.json', { cache: "no-store" });
                if (!res.ok) throw new Error("returns json fetch failed");
                const er = await res.json();

                // saving / nasdaq / gold ê°’ì„ currentPortfolioì— ì£¼ì…
                currentPortfolio = currentPortfolio.map(item => {
                    if (item.name.includes("êµ­ë‚´ ë°°ë‹¹ì£¼") || item.name.includes("ì ê¸ˆ")) {
                        return { ...item, rate: er.saving ?? item.rate };
                    }
                    if (item.name.includes("ë¯¸êµ­ í…Œí¬ì£¼") || item.name.includes("ë‚˜ìŠ¤ë‹¥")) {
                        return { ...item, rate: er.nasdaq ?? item.rate };
                    }
                    if (item.name.includes("ê¸ˆ/ì›ìì¬") || item.name.includes("ê¸ˆ")) {
                        return { ...item, rate: er.gold ?? item.rate };
                    }
                    return item;
                });

                console.log("âœ… expected returns loaded:", er);
            } catch (e) {
                console.warn("expected_returns.json ë¡œë“œ ì‹¤íŒ¨ â†’ ê¸°ë³¸ rate ìœ ì§€", e);
            }
        }

        // ì¶”ê°€: Goal ê³„ì‚° ê²°ê³¼ ì €ì¥ (í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ì—ì„œ í™œìš©)
        let goalCalculationResult = null;


        // --- 2. Utility Functions ---

        /**
         * Simple function to set the application state and re-render.
         * @param {string} newState The new state to set.
         */
        function setAppState(newState) {
            appState = newState;
            renderApp();
        }

        /**
         * Display a message box (replacement for alert/confirm).
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            const container = document.getElementById('app-container');
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs text-center">
                    <p class="text-gray-700 font-semibold mb-4">${message}</p>
                    <button id="close-msg" class="w-full hyu-blue text-white py-2 rounded-lg font-bold">í™•ì¸</button>
                </div>
            `;
            container.appendChild(overlay);

            document.getElementById('close-msg').onclick = () => {
                container.removeChild(overlay);
            };
        }

        // --- 3. Data & Firebase Setup ---

        /**
         * Initialize Firebase, sign in, and set up state.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                setAppState('WELCOME'); // Fallback to welcome if config is missing
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use initial auth token if provided, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase signed in. User ID:", userId);

                        // Check for consent (simulate simple session consent check)
                        if (localStorage.getItem('hyufa_consent') === 'agreed') {
                            setAppState('MAIN_CHAT');
                        } else {
                            setAppState('WELCOME');
                        }
                    } else {
                        userId = 'anonymous';
                        console.warn("Firebase signed out. Using anonymous ID.");
                        setAppState('WELCOME');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Error: " + error.code + ")");
                setAppState('WELCOME');
            }
        }

        /**
         * Load FAQ data from the uploaded JSON file.
         */
        async function loadFAQData() {
            try {
                // Simulate fetch of the uploaded file content
                const contentId = "uploaded:finance_chatbot_knowledge_104qa.json";
                const response = await fetch(`/api/files/download?contentFetchId=${contentId}`);
                if (!response.ok) throw new Error('Failed to fetch FAQ data');

                faqData = await response.json();
                console.log(`Loaded ${faqData.length} FAQ items.`);

            } catch (error) {
                console.error("Error loading FAQ data:", error);
                faqData = [
                    { category: "ì˜¤ë¥˜", question: "FAQ ë¡œë”© ì‹¤íŒ¨", answer: "FAQ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”." },
                    // Mock data if file loading fails
                    { category: "1. ê¸ˆìœµ ìƒì‹", question: "ì˜ˆÂ·ì ê¸ˆ ì°¨ì´", answer: "ì˜ˆê¸ˆì€ ì–¸ì œë“ ì§€ ë„£ê³  ëº„ ìˆ˜ ìˆëŠ” ëŒ€ì‹  ê¸ˆë¦¬ê°€ ë‚®ê³ , ì ê¸ˆì€ ë§¤ë‹¬ ì¼ì • ê¸ˆì•¡ì„ ë„£ëŠ” ëŒ€ì‹  ê¸ˆë¦¬ê°€ ì¡°ê¸ˆ ë” ë†’ì•„ìš”." }
                ];
            }
        }

        // --- 4. Gemini API Logic ---

        /**
         * Calls the Gemini API for chat response.
         * @param {string} prompt The user's query.
         */
        async function askHYUFA(prompt) {
            if (isChatLoading) return;

            // 1. Add user message to history
            const chatHistoryElement = document.getElementById('chat-history');
            if (!chatHistoryElement) return;

            chatHistory.push({ sender: 'user', text: prompt });
            renderChatHistory();

            // 2. Add loading message
            chatHistory.push({ sender: 'ai', text: '... ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.', loading: true });
            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
            isChatLoading = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

            // Prepare history for API call (excluding the temporary loading message)
            const apiContents = chatHistory.slice(0, -1).map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            // Add the new user prompt
            apiContents.push({
                role: 'user',
                parts: [{ text: prompt }]
            });


            const payload = {
                contents: apiContents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // 3. API Call with Exponential Backoff
            let responseText = "ì£„ì†¡í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ì— ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            responseText = candidate.content.parts[0].text;
                        } else {
                            responseText = "ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                        }
                        break; // Success
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`API Call failed (Attempt ${retryCount + 1}):`, error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // 4. Update history with final response
            const loadingIndex = chatHistory.findIndex(msg => msg.loading);
            if (loadingIndex !== -1) {
                chatHistory.splice(loadingIndex, 1); // Remove loading message
            }
            chatHistory.push({ sender: 'ai', text: responseText });
            isChatLoading = false;

            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }


        // --- 5. View Rendering Logic ---

        /**
         * Renders the chat history messages.
         */
        function renderChatHistory() {
            const historyDiv = document.getElementById('chat-history');
            if (!historyDiv) return;
            historyDiv.innerHTML = chatHistory.map(msg => `
                <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-xs sm:max-w-sm lg:max-w-md p-3 rounded-xl shadow-md ${
                        // ìˆ˜ì •: ì‚¬ìš©ì ë©”ì‹œì§€ (user)ì˜ ë°°ê²½ì„ í°ìƒ‰/ì˜…ì€ íšŒìƒ‰, í…ìŠ¤íŠ¸ë¥¼ ê²€ì •ìƒ‰(text-gray-800)ìœ¼ë¡œ ë³€ê²½
                        msg.sender === 'user'
                            ? 'bg-gray-200 text-gray-800 rounded-br-none'
                            : 'bg-gray-100 text-gray-800 rounded-tl-none'
                    }">
                        ${msg.loading ? '<i class="fa-solid fa-spinner fa-spin-pulse mr-2"></i>' : ''}
                        <p class="whitespace-pre-wrap">${msg.text}</p>
                    </div>
                </div>
            `).join('');
        }


        /**
         * Renders the main HYUFA application shell.
         */
        function renderApp() {
            const container = document.getElementById('app-container');

            // 1. Render Header (Always present on chat/menu screens)
            const header = `
                <div class="hyu-blue p-4 text-white shadow-lg flex justify-between items-center">
                    <h1 class="text-xl font-bold">HYUFA</h1>
                    ${appState !== 'WELCOME' && appState !== 'CONSENT' ? `
                        <button onclick="setAppState('MAIN_CHAT')" class="text-sm border border-white px-3 py-1 rounded-full hover:bg-white hover:text-hyu-blue transition">
                            <i class="fa-solid fa-house"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            container.innerHTML = header;

            // 2. Render Content based on state
            let content;
            switch (appState) {
                case 'WELCOME':
                    content = renderWelcome();
                    break;
                case 'CONSENT':
                    content = renderConsent();
                    break;
                case 'MAIN_CHAT':
                    content = renderMainChat();
                    break;
                case 'MENU':
                    content = renderMenu();
                    break;
                case 'GUIDE':
                    content = renderGuide();
                    break;
                case 'FAQ':
                    content = renderFAQ();
                    break;
                case 'GOAL_SETTING':
                    content = renderGoalSetting();
                    break;
                case 'PORTFOLIO':
                    content = renderPortfolio();
                    break;
                case 'PORTFOLIO_EDIT':
                    content = renderPortfolioEdit();
                    break;
                case 'CALCULATOR':
                    content = renderCalculator();
                    break;
                case 'CUSTOMER_CENTER':
                    content = renderCustomerCenter();
                    break;
                case 'FEEDBACK':
                    content = renderFeedback();
                    break;
                case 'LOADING':
                default:
                    content = renderLoading();
                    break;
            }
            container.innerHTML += content;

            // Post-render actions for specific screens
            if (appState === 'MAIN_CHAT') {
                renderChatHistory();
                const chatHistoryElement = document.getElementById('chat-history');
                if(chatHistoryElement) {
                    chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
                }
            } else if (appState === 'FAQ') {
                setupFAQToggle();
            } else if (appState === 'CALCULATOR') { // <--- ê³„ì‚°ê¸° ì˜¤ë¥˜ ìˆ˜ì • ë¶€ë¶„ (1/2)
                const currentCalc = sessionStorage.getItem('currentCalc') || 'ì ê¸ˆ';
                renderCalculatorForm(currentCalc); // ì´ˆê¸° í¼ ë Œë”ë§
            } else if (appState === 'GOAL_SETTING') {
                const currentGoalCalc = sessionStorage.getItem('currentGoalCalc') || 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ';
                renderGoalSettingForm(currentGoalCalc);
            } else if (appState === 'PORTFOLIO_EDIT') {
                checkPortfolioTotal(); // ì´ˆê¸° ì´í•©ê³„ ê³„ì‚°
            }
        }

        // --- View Specific HTML Generation ---

        // #001 ì²« í™”ë©´
        function renderWelcome() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <div class="text-7xl mb-4 text-hyu-blue">
                        <i class="fa-solid fa-piggy-bank"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-hyu-blue mb-2">ë°˜ê°‘ìŠµë‹ˆë‹¤.</h2>
                    <p class="text-2xl font-bold text-gray-700 mb-8">HYUFA ì…ë‹ˆë‹¤.</p>
                    <button onclick="setAppState('CONSENT')" class="hyu-blue text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-opacity-90 transition transform hover:scale-105">
                        ì„œë¹„ìŠ¤ ì‹œì‘í•˜ê¸°
                    </button>
                </div>
            `;
        }

        // #002 íŒì—… ì „í™˜ (ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜)
        function renderConsent() {
             return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</h2>

                    <p class="text-sm text-gray-700 mb-4">
                        ê³ ê°ë‹˜ì˜ ìƒë‹´ ì—…ë¬´ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” ê°œì¸ì •ë³´ë³´í˜¸ë²• ì œ 15ì¡° 1í•­ì— ë”°ë¼ ì•„ë˜ì˜ ë‚´ìš©ì— ëŒ€í•˜ì—¬ ê³ ê°ë‹˜ì˜ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>

                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-inner mb-6 text-sm space-y-3">
                        <p><strong>1. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ì´ìš© ëª©ì </strong><br>- ì„œë¹„ìŠ¤ ì´ìš©ì— ë”°ë¥¸ ìƒë‹´ ì—…ë¬´ ì²˜ë¦¬</p>
                        <p><strong>2. ìˆ˜ì§‘í•˜ë ¤ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª©</strong><br>- ì±—ë´‡ ìƒë‹´ë‚´ìš©</p>
                        <p><strong>3. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš© ê¸°ê°„</strong><br>- ìœ„ ê°œì¸ì •ë³´ëŠ” ìˆ˜ì§‘ ì´ìš©ì— ê´€í•œ ë™ì˜ ì´í›„ ì²˜ë¦¬ ì¢…ë£Œì¼ë¡œë¶€í„° 2ë…„ê°„ ìœ„ ì´ìš©ëª©ì ì„ ìœ„í•˜ì—¬ ë³´ìœ /ì´ìš©ë©ë‹ˆë‹¤.</p>
                        <p><strong>4. ì•ˆë‚´ì‚¬í•­</strong><br>- ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìœ¼ë©°, ê±°ë¶€ ì‹œ ìƒë‹´ì— ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>

                    <div class="flex space-x-4 mt-auto pt-4 border-t">
                        <button onclick="handleConsent(false)" class="flex-1 hyu-silver text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            ë¹„ë™ì˜ (ë‚˜ê°€ê¸°)
                        </button>
                        <button onclick="handleConsent(true)" class="flex-1 hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            ë™ì˜
                        </button>
                    </div>

                </div>
            `;
        }

        /**
         * Handle consent action.
         * @param {boolean} agreed True if agreed, false otherwise.
         */
        function handleConsent(agreed) {
            if (agreed) {
                localStorage.setItem('hyufa_consent', 'agreed');
                if (chatHistory.length === 0) {
                     chatHistory.push({ sender: 'ai', text: `ì•ˆë…•í•˜ì„¸ìš”.\nì¸ê³µì§€ëŠ¥ HYUFAì…ë‹ˆë‹¤.\në¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?\n\n+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ìš© ì•ˆë‚´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.` });
                }
                setAppState('MAIN_CHAT');
            } else {
                setAppState('WELCOME');
            }
        }

        // #003 ì±„íŒ… ë©”ì¸ í™”ë©´
        function renderMainChat() {
            // Expose handleChatSubmit to global scope
            window.handleChatSubmit = handleChatSubmit;
            window.setAppState = setAppState;

            return `
                <div class="flex flex-col flex-grow bg-white">
                    <div id="chat-history" class="flex-grow p-4 overflow-y-auto bg-gray-50 min-h-0"></div>

                    <div class="border-t bg-white flex items-center gap-2 px-3 py-3 sticky bottom-0 z-10 safe-bottom"
                        style="padding-bottom: calc(env(safe-area-inset-bottom) + 4px);">
                        
                        <button onclick="setAppState('MENU')" 
                                class="flex-shrink-0 text-hyu-blue text-3xl hover:opacity-75 transition">
                            <i class="fa-solid fa-circle-plus"></i>
                        </button>

                        <input id="chat-input" type="text" 
                            placeholder="ê¶ê¸ˆí•œ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." 
                            class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:border-hyu-blue min-w-0">

                        <button id="send-button" onclick="handleChatSubmit()" 
                                class="flex-shrink-0 hyu-blue text-white py-2 px-4 rounded-full font-bold hover:bg-opacity-90 transition">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>

                </div>
            `;
        }

        /**
         * Handle chat input submission (Enter or Send button).
         */
        function handleChatSubmit() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (prompt && !isChatLoading) {
                input.value = '';
                askHYUFA(prompt);
            }
        }

        // Add Enter key listener once the DOM is ready for chat
        document.addEventListener('keydown', (e) => {
            if (appState === 'MAIN_CHAT' && e.key === 'Enter') {
                handleChatSubmit();
            }
        });

        // #004 + í™”ë©´ (Menu) - hyufa5_ì§€ì•ˆì–¸ë‹ˆ.html ì½”ë“œ ë°˜ì˜
        function renderMenu() {
            const menuItems = [
                { name: 'HYUFA ì´ìš© ì•ˆë‚´', state: 'GUIDE', icon: 'fa-circle-info', color: 'bg-green-500' },
                { name: 'ìì£¼í•˜ëŠ” ì§ˆë¬¸', state: 'FAQ', icon: 'fa-circle-question', color: 'bg-yellow-500' },
                { name: 'ëª©í‘œ ê¸ˆì•¡ ì„¤ì •', state: 'GOAL_SETTING', icon: 'fa-bullseye', color: 'bg-red-500' }, // **ìˆ˜ì •: ëª©í‘œ ê¸ˆì•¡ ì„¤ì • ì¶”ê°€**
                { name: 'ê¸ˆìœµ ê³„ì‚°ê¸°', state: 'CALCULATOR', icon: 'fa-calculator', color: 'bg-purple-500' },
                { name: 'HYUFA ê³ ê°ì„¼í„°', state: 'CUSTOMER_CENTER', icon: 'fa-headset', color: 'bg-blue-500' },
                { name: 'HYUFA ì˜ê²¬ ë‚¨ê¸°ê¸°', state: 'FEEDBACK', icon: 'fa-comment-dots', color: 'bg-pink-500' },
            ]

            return `
                <div class="flex flex-col flex-grow bg-slate-100 p-4 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">ë©”ì¸ ë©”ë‰´</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${menuItems
                            .map(
                                (item) => `
                                <button onclick="setAppState('${item.state}')" class="menu-card glass-card p-4 rounded-xl shadow-soft text-center flex flex-col items-center justify-center space-y-2">
                                    <div class="w-12 h-12 ${item.color} text-white rounded-full flex items-center justify-center text-xl shadow-md">
                                        <i class="fa-solid ${item.icon}"></i>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-800">${item.name}</span>
                                </button>
                            `
                            )
                            .join('')}
                    </div>
                    <div class="mt-8 p-4 bg-white rounded-xl shadow-soft text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">HYUFAëŠ” ì¸ê³µì§€ëŠ¥ ê¸ˆìœµ ë¹„ì„œì…ë‹ˆë‹¤.</p>
                        <p>ì œê³µë˜ëŠ” ì •ë³´ëŠ” ì°¸ê³  ìë£Œë¡œë§Œ í™œìš©í•˜ì‹œê³ , ì •í™•í•œ ê¸ˆìœµ ê±°ë˜ëŠ” ì€í–‰ ì°½êµ¬ ë˜ëŠ” ê³µì‹ ê¸ˆìœµê¸°ê´€ì„ í†µí•´ ì§„í–‰í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
        }
        
        // #005 HYUFA ì´ìš© ì•ˆë‚´
        function renderGuide() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA ì´ìš© ì•ˆë‚´</h2>
                    
                    <section class="mb-6 bg-white p-5 rounded-xl shadow-lg border-l-4 border-hyu-blue">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-robot mr-3 text-hyu-blue"></i>HYUFAì˜ ëŠ¥ë ¥ê³¼ í•œê³„</h3>
                        <p class="text-sm text-gray-700 leading-relaxed">
                            HYUFAëŠ” ëŒ€í•™ìƒ ë° ì‚¬íšŒì´ˆë…„ìƒì—ê²Œ íŠ¹í™”ëœ ê¸ˆìœµ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ìƒë‹´í•©ë‹ˆë‹¤. ê¸ˆìœµ ìƒí’ˆ 'ì¶”ì²œ'ë³´ë‹¤ëŠ” 'ì›ë¦¬ ì„¤ëª… ë° ì¡°ì–¸'ì— ì§‘ì¤‘í•˜ë©°, íˆ¬ì ê¶Œìœ ë‚˜ ìˆ˜ìµ ë³´ì¥ í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </p>
                    </section>

                    <section class="mb-6 bg-white p-5 rounded-xl shadow-lg border-l-4 border-hyu-orange">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-lightbulb mr-3 text-hyu-orange"></i>ì´ìš© Tip</h3>
                        <ul class="text-sm list-disc pl-5 space-y-1">
                            <li>HYUFAì—ê²Œ ì§§ê³  ê°„ë‹¨í•œ í•µì‹¬ë§Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš” !</li>
                            <li>ë³¸ ì„œë¹„ìŠ¤ëŠ” â€˜ì¸ê°„-ì¸ê³µì§€ëŠ¥ í˜‘ì—… ì œí’ˆ ì„œë¹„ìŠ¤ ì„¤ê³„â€™ ìˆ˜ì—… íŒ€ í”„ë¡œì íŠ¸ë¡œ, ì‚¬ì „ ì„¤ê³„í•œ í”„ë¡¬í”„íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</li>
                            <li>ë”°ë¼ì„œ ìƒìš© AIë§Œí¼ì˜ ì‘ë‹µ ìœ ì—°ì„±ì—ëŠ” ì¼ë¶€ ì œí•œì´ ìˆìœ¼ë©°, ë³¸ ì±—ë´‡ì€ ì‚¬ìš©ì ê²½í—˜ ê²€ì¦ê³¼ ì„œë¹„ìŠ¤ ì½˜ì…‰íŠ¸ ì œì‹œ ëª©ì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                        <p class="text-center mt-3 text-sm font-semibold text-hyu-coral">
                            ê·¸ë˜ë„ ì²˜ìŒ ê¸ˆìœµì„ ì ‘í•  ë•Œ ëŠë¼ëŠ” ë§‰ë§‰í•¨ì„ ëœì–´ë“œë¦¬ê¸° ìœ„í•´ ì„¤ê³„í•œ ì„œë¹„ìŠ¤ë¡œ ë§ì€ ì´ìš© ë¶€íƒë“œë¦½ë‹ˆë‹¤ â™¥ï¸
                        </p>
                    </section>
                </div>
            `;
        }

        // #006 ìì£¼í•˜ëŠ” ì§ˆë¬¸
        function renderFAQ() {
            // Expose setupFAQToggle to global scope
            window.setupFAQToggle = setupFAQToggle;
            
            const categories = [...new Set(faqData.map(item => item.category))].sort();
            const faqList = categories.map(category => {
                const items = faqData.filter(item => item.category === category);
                const itemsHtml = items.map((item, index) => `
                    <div class="border-b last:border-b-0">
                        <button class="faq-question w-full text-left py-3 px-4 font-semibold text-gray-700 hover:bg-gray-50 transition flex justify-between items-center" data-index="${category}-${index}">
                            ${item.question}
                            <i class="fa-solid fa-chevron-down text-xs ml-2 transition-transform duration-300"></i>
                        </button>
                        <div id="answer-${category}-${index}" class="faq-answer max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-gray-50 px-4">
                            <div class="py-3 text-sm text-gray-600 whitespace-pre-wrap">${item.answer}</div>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="mb-6 bg-white rounded-xl shadow-lg overflow-hidden">
                        <h3 class="text-xl font-bold p-4 border-b text-hyu-orange bg-gray-100">${category}</h3>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">ìì£¼ í•˜ëŠ” ì§ˆë¬¸ (FAQ)</h2>
                    <p class="text-sm text-gray-600 mb-4">ê¶ê¸ˆí•œ ì§ˆë¬¸ì„ ì„ íƒí•˜ì‹œë©´ HYUFAì˜ ë‹µë³€ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
                    ${faqList}
                </div>
            `;
        }

        /**
         * Setup click listener for FAQ toggles after rendering.
         */
        function setupFAQToggle() {
            document.querySelectorAll('.faq-question').forEach(button => {
                button.onclick = () => {
                    const index = button.getAttribute('data-index');
                    const answerDiv = document.getElementById(`answer-${index}`);
                    const icon = button.querySelector('i');
                    
                    const isOpen = answerDiv.style.maxHeight && answerDiv.style.maxHeight !== '0px';

                    // Close all others
                    document.querySelectorAll('.faq-answer').forEach(el => {
                        if (el.id !== `answer-${index}`) {
                            el.style.maxHeight = '0';
                        }
                    });
                    document.querySelectorAll('.faq-question i').forEach(el => {
                        if (el !== icon) {
                             el.style.transform = 'rotate(0deg)';
                        }
                    });


                    // Toggle current
                    if (isOpen) {
                        answerDiv.style.maxHeight = '0';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        answerDiv.style.maxHeight = answerDiv.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                };
            });
        }

        // --- #007 ëª©í‘œ ê¸ˆì•¡ ì„¤ì • (ìƒˆë¡œ ì¶”ê°€) ---
        function renderGoalSetting() {
            window.selectGoalCalculator = selectGoalCalculator;
            window.calculateGoal = calculateGoal;

            const currentGoalCalc = sessionStorage.getItem('currentGoalCalc') || 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ';

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">ëª©í‘œ ê¸ˆì•¡ ì„¤ì •</h2>
                    
                    <div class="flex justify-around mb-6 bg-white p-2 rounded-full shadow-inner">
                        <button onclick="selectGoalCalculator('ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentGoalCalc === 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ</button>
                        <button onclick="selectGoalCalculator('ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentGoalCalc === 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ</button>
                    </div>

                    <div id="goal-setting-form" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        </div>

                    <div id="goal-setting-result" class="p-5 rounded-xl text-center ${goalCalculationResult ? '' : 'hidden'} mb-6">
                         ${goalCalculationResult ? renderGoalSettingResult(goalCalculationResult) : ''}
                        </div>

                    <div class="mt-auto">
                        <button onclick="setAppState('PORTFOLIO')" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            ì¶”ì²œ í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Selects the goal calculator type and re-renders the form.
         * @param {string} type 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ' or 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ'.
         */
        function selectGoalCalculator(type) {
            // 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ'ëŠ” ëª©í‘œ ê¸ˆì•¡ì„ ìœ„í•´ í•„ìš”í•œ ì›” ë‚©ì…ì•¡ ê³„ì‚° (ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥)
            // 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ'ëŠ” ì›” ë‚©ì…ì•¡ìœ¼ë¡œ ëª¨ì„ ìˆ˜ ìˆëŠ” ëª©í‘œ ê¸ˆì•¡ ê³„ì‚° (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
            sessionStorage.setItem('currentGoalCalc', type);
            // ê²°ê³¼ë¥¼ ìˆ¨ê¹€ ì²˜ë¦¬í•˜ì—¬ ìƒˆë¡œìš´ ê³„ì‚°ì„ ìœ ë„
            const resultDiv = document.getElementById('goal-setting-result');
            if(resultDiv) resultDiv.classList.add('hidden');
            renderApp();
        }

        /**
         * Renders the dynamic goal setting form.
         * @param {string} currentGoalCalc 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ' or 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ'.
         */
        function renderGoalSettingForm(currentGoalCalc) {
            const formDiv = document.getElementById('goal-setting-form');
            if (!formDiv) return;
            
            let formHtml = '';

            if (currentGoalCalc === 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ') {
                // Default values for better UX
                const defaultMonths = 36;
                const defaultMonthly = 300000;

                formHtml = `
                    <h3 class="text-lg font-bold text-hyu-orange mb-4">í˜„ì¬ì˜ ì €ì¶• ê³„íšìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ë¯¸ë˜ ê¸ˆì•¡ì€?</h3>
                    <div class="p-4 bg-white rounded-lg shadow space-y-4">
                        <label class="block mb-2 text-sm font-semibold">ì €ì¶• ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number" id="goal-input-months" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultMonths}">
                        <label class="block mb-2 text-sm font-semibold">ë§¤ì›” ë‚©ì…ì•¡ (ì›)</label>
                        <input type="text" id="goal-input-monthly" 
                                oninput="formatNumberInput(this)" 
                                class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" 
                                value="${defaultMonthly.toLocaleString()}">

                        <button onclick="calculateGoal('ëª¨ì„ê¹Œ')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                            ì˜ˆìƒ ê¸ˆì•¡ í™•ì¸í•˜ê¸°
                        </button>
                    </div>
                `;
            } else if (currentGoalCalc === 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ') {
                // Default values for better UX
                const defaultMonths = 36;
                const defaultGoal = 10000000;

                 formHtml = `
                    <h3 class="text-lg font-bold text-hyu-orange mb-4">ëª©í‘œ ê¸ˆì•¡ì„ ìœ„í•´ ì–¼ë§ˆë¥¼ ì €ì¶•í•´ì•¼ í• ê¹Œìš”?</h3>
                    <div class="p-4 bg-white rounded-lg shadow space-y-4">
                        <label class="block mb-2 text-sm font-semibold">ì €ì¶• ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number" id="goal-input-months-target" class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="${defaultMonths}">
                        <label class="block mb-2 text-sm font-semibold">ëª©í‘œ ê¸ˆì•¡ (ì›)</label>
                        <input type="text" id="goal-input-target" 
                                oninput="formatNumberInput(this)" 
                                class="w-full p-3 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" 
                                value="${defaultGoal.toLocaleString()}">

                        <button onclick="calculateGoal('ë„£ì„ê¹Œ')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                            í•„ìš” ë‚©ì…ì•¡ í™•ì¸í•˜ê¸°
                        </button>
                    </div>
                `;
            }

            formDiv.innerHTML = formHtml;

        // ğŸ‘‰ ë§¤ì›” ë‚©ì…ì•¡ ì…ë ¥ê°’ì— ìë™ ì½¤ë§ˆ ì ìš©
        const monthlyInput = document.getElementById("goal-input-monthly");
        if (monthlyInput) {
            monthlyInput.addEventListener("input", (e) => {
                let value = e.target.value.replace(/,/g, "");
                if (value === "") {
                    e.target.value = "";
                    return;
                }
                if (!isNaN(value)) {
                    e.target.value = Number(value).toLocaleString();
                }
            });
        }
        const targetInput = document.getElementById("goal-input-target");
        if (targetInput) {
            targetInput.addEventListener("input", (e) => {
                let value = e.target.value.replace(/,/g, "");
                if (value === "") {
                    e.target.value = "";
                    return;
                }
                if (!isNaN(value)) {
                    e.target.value = Number(value).toLocaleString();
                }
            });
        }
        }

        /**
        * Helper function to calculate Future Value of Annuity Due.
        * Assumes monthly contribution at the start of the month.
        */
        function calculateFV(monthly, months, annualRate) {
            const monthlyRate = annualRate / 12;
            let futureValue = 0;
            if (monthlyRate === 0) {
                 return monthly * months;
            }
            // Future Value of Annuity Due: FV = P * [((1+r)^n - 1) / r] * (1+r)
            // But we use a simpler loop for better clarity and to handle potential floating point issues in the simplified context.
             for (let i = 0; i < months; i++) {
                // Contributions at the start of the month, compounds for one more period
                futureValue += monthly * Math.pow(1 + monthlyRate, months - i);
            }
            return futureValue;
        }

        /**
        * Calculates the goal scenario results (for 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ' - Predict Future Value).
        * OR Calculates the required monthly payment (for 'ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ' - Predict Monthly Payment).
        * @param {string} mode 'ëª¨ì„ê¹Œ' or 'ë„£ì„ê¹Œ'.
        */
        function calculateGoal(mode) {
            const resultDiv = document.getElementById('goal-setting-result');
            let resultHtml = '';
            goalCalculationResult = null; // Reset previous result

            try {
                if (mode === 'ëª¨ì„ê¹Œ') {
                    // (ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ) - ì›” ë‚©ì…ì•¡ìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ë¯¸ë˜ ê¸ˆì•¡ ê³„ì‚°
                    const monthly = parseFloat(document.getElementById('goal-input-monthly').value.replace(/,/g, ''));
                    const months = parseInt(document.getElementById('goal-input-months').value);

                    if (monthly <= 0 || months <= 0 || isNaN(monthly) || isNaN(months)) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");
                    
                    const principal = monthly * months;
                    const results = {};

                    // CASE 1: êµ­ë‚´ ë°°ë‹¹ì£¼ ETF (Simulate Installment Savings - Simple Interest, as per original logic for 3% saving)
                    const itemSavings = currentPortfolio.find(p => p.name.includes("êµ­ë‚´ ë°°ë‹¹ì£¼"));
                    // **ìˆ˜ì • ì‹œì‘: NaN ë°©ì§€ë¥¼ ìœ„í•´ ìœ íš¨ì„± ê²€ì‚¬ ë° ê¸°ë³¸ê°’ ì„¤ì •**
                    const rateSavings = itemSavings && !isNaN(itemSavings.rate) ? itemSavings.rate : 0.03;
                    // **ìˆ˜ì • ë**
                    
                    let interestSavings = 0;
                    for (let i = 1; i <= months; i++) {
                        // Simple interest on each monthly deposit: P * R * (T/12)
                        interestSavings += monthly * rateSavings * ((months - i + 1) / 12);
                    }
                    // **ìˆ˜ì •: ì´ë¦„ì—ì„œ ìˆ˜ìµë¥  ì œê±°**
                    results.case1 = { name: 'CASE 1. êµ­ë‚´ ë°°ë‹¹ì£¼ ETF', rate: rateSavings, amount: principal + interestSavings, color: 'border-hyu-green' };

                    // CASE 2: ë¯¸êµ­ í…Œí¬ì£¼ ì¸ë±ìŠ¤ (Compound Interest - Annual Rate)
                    const itemNasdaq = currentPortfolio.find(p => p.name.includes("ë¯¸êµ­ í…Œí¬ì£¼"));
                    // **ìˆ˜ì • ì‹œì‘: NaN ë°©ì§€ë¥¼ ìœ„í•´ ìœ íš¨ì„± ê²€ì‚¬ ë° ê¸°ë³¸ê°’ ì„¤ì •**
                    const rateNasdaq = itemNasdaq && !isNaN(itemNasdaq.rate) ? itemNasdaq.rate : 0.10;
                    // **ìˆ˜ì • ë**
                    // **ìˆ˜ì •: ì´ë¦„ì—ì„œ ìˆ˜ìµë¥  ì œê±°**
                    results.case2 = { name: 'CASE 2. ë¯¸êµ­ í…Œí¬ì£¼ ì¸ë±ìŠ¤', rate: rateNasdaq, amount: calculateFV(monthly, months, rateNasdaq), color: 'border-hyu-orange' };

                    // CASE 3: ê¸ˆ/ì›ìì¬ í€ë“œ (Compound Interest - Annual Rate)
                    const itemGold = currentPortfolio.find(p => p.name.includes("ê¸ˆ/ì›ìì¬"));
                    // **ìˆ˜ì • ì‹œì‘: NaN ë°©ì§€ë¥¼ ìœ„í•´ ìœ íš¨ì„± ê²€ì‚¬ ë° ê¸°ë³¸ê°’ ì„¤ì •**
                    const rateGold = itemGold && !isNaN(itemGold.rate) ? itemGold.rate : 0.07;
                    // **ìˆ˜ì • ë**
                    // **ìˆ˜ì •: ì´ë¦„ì—ì„œ ìˆ˜ìµë¥  ì œê±°**
                    results.case3 = { name: 'CASE 3. ê¸ˆ/ì›ìì¬ í€ë“œ', rate: rateGold, amount: calculateFV(monthly, months, rateGold), color: 'border-hyu-gold' };

                    goalCalculationResult = { mode: 'ëª¨ì„ê¹Œ', monthly: monthly, months: months, principal: principal, results: results };
                    resultHtml = renderGoalSettingResult(goalCalculationResult);
                    
                } else if (mode === 'ë„£ì„ê¹Œ') {
                    // (ì–¼ë§ˆë¥¼ ë„£ì„ê¹Œ) - ëª©í‘œ ê¸ˆì•¡ì„ ìœ„í•´ í•„ìš”í•œ ì›” ë‚©ì…ì•¡ ê³„ì‚°
                    const months = parseInt(document.getElementById('goal-input-months-target').value);
                    const targetAmount = parseFloat(document.getElementById('goal-input-target').value.replace(/,/g, ''));

                    if (targetAmount <= 0 || months <= 0 || isNaN(targetAmount) || isNaN(months)) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");

                    // CASE 1: êµ­ë‚´ ë°°ë‹¹ì£¼ ETF (Simple Interest - Monthly Basis, for comparison)
                    const itemSavings = currentPortfolio.find(p => p.name.includes("êµ­ë‚´ ë°°ë‹¹ì£¼"));
                    const rateSavings = itemSavings && !isNaN(itemSavings.rate) ? itemSavings.rate : 0.03; // **ìˆ˜ì •: NaN ë°©ì§€**
                    // í•„ìš”í•œ ì›” ë‚©ì…ì•¡ (P*N + I) = T.  I = P * R/12 * (N*(N+1)/2)
                    // P * (N + R/12 * N*(N+1)/2) = T
                    const savingsFactor = months + rateSavings / 12 * (months * (months + 1) / 2);
                    const monthlySavings = targetAmount / savingsFactor;

                    // CASE 2: ë¯¸êµ­ í…Œí¬ì£¼ ì¸ë±ìŠ¤ (Compound Interest - Annuity Due)
                    const itemNasdaq = currentPortfolio.find(p => p.name.includes("ë¯¸êµ­ í…Œí¬ì£¼"));
                    const rateNasdaq = itemNasdaq && !isNaN(itemNasdaq.rate) ? itemNasdaq.rate : 0.10; // **ìˆ˜ì •: NaN ë°©ì§€**
                    const monthlyRateNasdaq = rateNasdaq / 12;
                    // Annuity Due: FV = P * [((1+r)^n - 1) / r] * (1+r)
                    const compoundFactorNasdaq = ((Math.pow(1 + monthlyRateNasdaq, months) - 1) / monthlyRateNasdaq) * (1 + monthlyRateNasdaq);
                    const monthlyNasdaq = targetAmount / compoundFactorNasdaq;

                    // CASE 3: ê¸ˆ/ì›ìì¬ í€ë“œ (Compound Interest - Annuity Due)
                    const itemGold = currentPortfolio.find(p => p.name.includes("ê¸ˆ/ì›ìì¬"));
                    const rateGold = itemGold && !isNaN(itemGold.rate) ? itemGold.rate : 0.07; // **ìˆ˜ì •: NaN ë°©ì§€**
                    const monthlyRateGold = rateGold / 12;
                    const compoundFactorGold = ((Math.pow(1 + monthlyRateGold, months) - 1) / monthlyRateGold) * (1 + monthlyRateGold);
                    const monthlyGold = targetAmount / compoundFactorGold;
                    
                    const results = {
                         // **ìˆ˜ì •: ì´ë¦„ì—ì„œ ìˆ˜ìµë¥  ì œê±°**
                         case1: { name: 'CASE 1. êµ­ë‚´ ë°°ë‹¹ì£¼ ETF', rate: rateSavings, amount: monthlySavings, color: 'border-hyu-green' },
                         case2: { name: 'CASE 2. ë¯¸êµ­ í…Œí¬ì£¼ ì¸ë±ìŠ¤', rate: rateNasdaq, amount: monthlyNasdaq, color: 'border-hyu-orange' },
                         case3: { name: 'CASE 3. ê¸ˆ/ì›ìì¬ í€ë“œ', rate: rateGold, amount: monthlyGold, color: 'border-hyu-gold' }
                    };

                    goalCalculationResult = { mode: 'ë„£ì„ê¹Œ', targetAmount: targetAmount, months: months, results: results };
                    resultHtml = renderGoalSettingResult(goalCalculationResult);
                }

                resultDiv.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Goal Calculation Error:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">ì…ë ¥ê°’ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>`;
                resultDiv.classList.remove('hidden');
            }
        }


        /**
         * Renders the result section for Goal Setting.
         */
        function renderGoalSettingResult(data) {
             const createCaseBox = (name, rate, amount, color) => `
                <div class="p-4 rounded-xl border-l-4 ${color} bg-white">
                    <p class="font-semibold text-gray-800 mb-2">${name}</p>
                    <div class="text-sm text-gray-600 space-y-1">
                        ${data.mode === 'ëª¨ì„ê¹Œ' 
                            // **ìˆ˜ì •: ì˜ˆìƒ ìˆ˜ìµë¥  ì¶œë ¥ í¬ë§· ê°œì„ **
                            ? `<span>ì˜ˆìƒ ìˆ˜ìµë¥ : ${Math.round(rate * 100)}%</span><span class="block font-bold text-base text-hyu-blue">ë§Œê¸° ì˜ˆìƒ ê¸ˆì•¡: ${Math.round(amount).toLocaleString()} ì›</span>` 
                            : `<span>ì˜ˆìƒ ìˆ˜ìµë¥ : ${Math.round(rate * 100)}%</span><span class="block font-bold text-base text-hyu-blue">í•„ìš” ì›” ë‚©ì…ì•¡: ${Math.round(amount).toLocaleString()} ì›</span>`
                        }
                    </div>
                </div>
            `;
            
            let titleText = '';
            if (data.mode === 'ëª¨ì„ê¹Œ') {
                titleText = `ğŸ‰ ì˜ˆìƒê¸ˆì•¡ í™•ì¸ ê²°ê³¼ (ì›ê¸ˆ: ${data.principal.toLocaleString()}ì›)`;
            } else if (data.mode === 'ë„£ì„ê¹Œ') {
                titleText = `ğŸ’° ëª©í‘œ ê¸ˆì•¡ ë‹¬ì„± ê³„íš (ëª©í‘œ: ${data.targetAmount.toLocaleString()}ì› / ê¸°ê°„: ${data.months}ê°œì›”)`;
            }

            return `
                <div class="text-left">
                    <p class="text-lg font-bold mb-4">
                        <span class="text-hyu-orange">${titleText}</span>
                    </p>
                    <div class="space-y-3">
                        ${createCaseBox(data.results.case1.name, data.results.case1.rate, data.results.case1.amount, data.results.case1.color)}
                        ${createCaseBox(data.results.case2.name, data.results.case2.rate, data.results.case2.amount, data.results.case2.color)}
                        ${createCaseBox(data.results.case3.name, data.results.case3.rate, data.results.case3.amount, data.results.case3.color)}
                    </div>
                    <p class="text-xs text-gray-500 mt-4"> * ì˜ˆìƒ ê¸ˆì•¡ì€ ê³¼ê±° ìˆ˜ìµë¥ ì„ ë‹¨ìˆœ ì ìš©í•œ ê²°ê³¼ì´ë©°, ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. </p>
                </div>
            `;
        }


        // #007 í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œ (ê¸°ì¡´ #007ì—ì„œ ë²ˆí˜¸ ë³€ê²½ ë° ìˆ˜ì •)
        function renderPortfolio() {
             // Utility function to get tailwind color class name from mock color name
            const getColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'text-hyu-green';
                    case 'hyu-orange': return 'text-hyu-orange';
                    case 'hyu-gold': return 'text-hyu-gold';
                    default: return 'text-gray-500';
                }
            };
            
            // Utility function for border color
            const getBorderColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'border-hyu-green';
                    case 'hyu-orange': return 'border-hyu-orange';
                    case 'hyu-gold': return 'border-hyu-gold';
                    default: return 'border-gray-500';
                }
            };
            
            // Calculate pie chart colors and stops
            let currentStop = 0;
            const conicStops = currentPortfolio.map(item => {
                const start = currentStop;
                currentStop += item.percentage;
                // Use hex codes for background conic-gradient
                const hexColor = item.color.replace('hyu-blue', '#0E4A84').replace('hyu-green', '#7DB928').replace('hyu-orange', '#F08100').replace('hyu-gold', '#88774F');
                return `${hexColor} ${start}% ${currentStop}%`;
            }).join(', ');
            
            // Calculate total portfolio value if goal data is available
            let totalPortfolioValueHtml = '';
            let totalPortfolioValue = 0;

            // **ìˆ˜ì • ì‹œì‘: NaN ì˜¤ë¥˜ ë° ìƒ‰ìƒ ë³€ê²½ ë°˜ì˜**
            if (goalCalculationResult && goalCalculationResult.mode === 'ëª¨ì„ê¹Œ') {
                const results = goalCalculationResult.results;
                
                // Get the final amounts from the calculation result
                const case1Amount = results.case1.amount;
                const case2Amount = results.case2.amount;
                const case3Amount = results.case3.amount;

                // Map final amounts to portfolio items based on name (a bit fragile, but works for this mock)
                const item1 = currentPortfolio.find(p => p.name.includes("êµ­ë‚´ ë°°ë‹¹ì£¼"));
                const item2 = currentPortfolio.find(p => p.name.includes("ë¯¸êµ­ í…Œí¬ì£¼"));
                const item3 = currentPortfolio.find(p => p.name.includes("ê¸ˆ/ì›ìì¬"));

                // Calculate weighted total value
                totalPortfolioValue = 
                    (case1Amount * (item1.percentage / 100)) +
                    (case2Amount * (item2.percentage / 100)) +
                    (case3Amount * (item3.percentage / 100));

                // NaN ë°©ì§€ ë° í¬ë§·íŒ…
                const displayAmount = isNaN(totalPortfolioValue) || totalPortfolioValue <= 0 ? 'ëª©í‘œ ì„¤ì • í•„ìš”' : Math.round(totalPortfolioValue).toLocaleString();
                
                // 1. ê¸€ì”¨ìƒ‰ text-hyu-blue ì ìš©, 2. ë°°ê²½ ë° border ìŠ¤íƒ€ì¼ ë³€ê²½
                totalPortfolioValueHtml = `
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg text-center shadow-md border-b-4 border-hyu-blue">
                        <p class="text-sm text-gray-700">í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ì ìš© ì˜ˆìƒ ë§Œê¸° ê¸ˆì•¡</p>
                        <p class="text-xl font-extrabold text-hyu-blue mt-1">${displayAmount} ì›</p> 
                    </div>
                `;
            } else {
                 // ëª©í‘œ ê¸ˆì•¡ ì„¤ì •ì´ ì•ˆ ëœ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
                totalPortfolioValueHtml = `
                    <div class="mt-4 p-3 bg-red-50 border border-red-200 text-center rounded-lg shadow-md">
                        <p class="text-sm font-semibold text-red-600">âš ï¸ ëª©í‘œ ê¸ˆì•¡ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <p class="text-xs text-red-500 mt-1">ì´ì „ í˜ì´ì§€ì—ì„œ 'ì–¼ë§ˆë¥¼ ëª¨ì„ê¹Œ' íƒ­ì˜ 'ì˜ˆìƒ ê¸ˆì•¡ í™•ì¸í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            }
            // **ìˆ˜ì • ë**


            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œ</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <p class="text-lg font-semibold mb-4 text-center">ë‚˜ì˜ íˆ¬ì ì„±í–¥ ë¶„ì„ ê²°ê³¼: <span class="text-hyu-orange">ê³µê²© íˆ¬ìí˜•</span></p>
                        <p class="text-sm text-gray-600 mb-6 text-center">
                            * í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œì€ ë‹¨ìˆœ ì˜ˆì‹œì´ë©°, ì‹¤ì œ íˆ¬ìëŠ” ê°œì¸ì˜ ì±…ì„ í•˜ì— ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.
                        </p>

                        <div class="w-full flex justify-center mb-6">
                            <div class="w-36 h-36 rounded-full relative" style="background: conic-gradient(${conicStops}); box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                                <div class="absolute inset-4 bg-white rounded-full flex items-center justify-center">
                                    <span class="text-2xl font-bold text-hyu-blue">100%</span>
                                </div>
                            </div>
                        </div>

                        ${totalPortfolioValueHtml} 

                        <div class="space-y-4 mb-6 mt-4">
                            ${currentPortfolio.map(item => `
                                <div class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 ${getBorderColorClass(item.color)}">
                                    <i class="fa-solid ${item.icon} text-xl w-6 ${getColorClass(item.color)}"></i>
                                    <div class="ml-4 flex-grow">
                                        <div class="flex justify-between items-center">
                                            <span class="font-semibold text-gray-800">${item.name}</span>
                                            <span class="font-bold text-lg ${getColorClass(item.color)}">${item.percentage}%</span>
                                        </div>
                                        <p class="text-xs text-gray-500">${item.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="setAppState('PORTFOLIO_EDIT')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg shadow-md hover:opacity-90 transition">
                            í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ë¹„ì¤‘ ìˆ˜ì •í•˜ê¸°
                        </button>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œ ì°¸ê³  ì‚¬í•­</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>ìì„¸í•œ íˆ¬ì ë¹„ì¤‘ì€ ê°œì¸ì˜ ìƒí™©ì— ë§ê²Œ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                            <li>í•´ë‹¹ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” ì‹œì¥ ìƒí™©ì— ë”°ë¼ ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // --- #007-1 í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ìˆ˜ì • (ìƒˆë¡œ ì¶”ê°€) ---
        function renderPortfolioEdit() {
            window.savePortfolio = savePortfolio;

            // Utility function to get tailwind color class name from mock color name
            const getColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'text-hyu-green';
                    case 'hyu-orange': return 'text-hyu-orange';
                    case 'hyu-gold': return 'text-hyu-gold';
                    default: return 'text-gray-500';
                }
            };
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ìˆ˜ì •</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <p class="text-sm text-gray-600 mb-4 font-semibold text-center">
                            ê° ìì‚°ì˜ ë¹„ì¤‘ì„ ìˆ˜ì •í•˜ê³ , í•©ê³„ê°€ <span class="text-hyu-orange">100%</span>ê°€ ë˜ë„ë¡ ë§ì¶°ì£¼ì„¸ìš”.
                        </p>

                        <div id="portfolio-edit-list" class="space-y-4 mb-4">
                            ${currentPortfolio.map((item, index) => `
                                <div class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-hyu-blue">
                                    <i class="fa-solid ${item.icon} text-xl w-6 ${getColorClass(item.color)}"></i>
                                    <div class="ml-4 flex-grow">
                                        <span class="font-semibold text-gray-800">${item.name}</span>
                                    </div>
                                    <input type="number" 
                                           data-index="${index}" 
                                           id="edit-percentage-${index}" 
                                           class="w-20 p-2 border text-right rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" 
                                           value="${item.percentage}" 
                                           min="0" max="100"
                                           oninput="checkPortfolioTotal()">
                                    <span class="ml-2 text-lg font-bold">%</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-between items-center p-3 border-t-2 border-hyu-blue mt-4">
                            <span class="text-lg font-bold text-gray-800">ì´í•©ê³„</span>
                            <span id="portfolio-total" class="text-2xl font-extrabold text-hyu-orange">100%</span>
                        </div>
                        
                        <button onclick="savePortfolio()" id="save-portfolio-btn" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition mt-6">
                            ë¹„ì¤‘ ì €ì¥í•˜ê¸°
                        </button>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">ì£¼ì˜ ì‚¬í•­</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>ì´í•©ê³„ê°€ 100%ê°€ ë˜ì§€ ì•Šìœ¼ë©´ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Checks the total percentage of the portfolio during editing.
         */
        window.checkPortfolioTotal = function() {
            const inputs = document.querySelectorAll('#portfolio-edit-list input');
            let total = 0;
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });

            const totalSpan = document.getElementById('portfolio-total');
            const saveBtn = document.getElementById('save-portfolio-btn');

            totalSpan.textContent = `${total}%`;
            
            if (total === 100) {
                totalSpan.classList.remove('text-red-500');
                totalSpan.classList.add('text-hyu-orange');
                saveBtn.disabled = false;
                saveBtn.classList.remove('hyu-silver');
                saveBtn.classList.add('hyu-blue');
            } else {
                totalSpan.classList.remove('text-hyu-orange');
                totalSpan.classList.add('text-red-500');
                saveBtn.disabled = true;
                saveBtn.classList.remove('hyu-blue');
                saveBtn.classList.add('hyu-silver');
            }
        };
        
        /**
         * Saves the updated portfolio percentages.
         */
        function savePortfolio() {
            const inputs = document.querySelectorAll('#portfolio-edit-list input');
            let total = 0;
            const newPortfolio = [];

            inputs.forEach(input => {
                const percentage = parseInt(input.value) || 0;
                total += percentage;
                const index = parseInt(input.getAttribute('data-index'));
                
                // Deep copy and update
                newPortfolio.push({
                    ...currentPortfolio[index],
                    percentage: percentage
                });
            });

            if (total !== 100) {
                showMessage("ì´í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„ì¬ í•©ê³„: " + total + "%");
                return;
            }

            currentPortfolio = newPortfolio;
            localStorage.setItem('hyufa_portfolio', JSON.stringify(currentPortfolio));
            showMessage("í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            setAppState('PORTFOLIO'); // Return to the portfolio view
        }


        // #008 ê¸ˆìœµ ê³„ì‚°ê¸° (ê¸°ì¡´ #008ì—ì„œ ë²ˆí˜¸ ë³€ê²½)
        function renderCalculator() {
            // Expose utility functions to global scope
            window.selectCalculator = selectCalculator;
            window.calculateFinance = calculateFinance;

            // Simple state for calculator type
            const currentCalc = sessionStorage.getItem('currentCalc') || 'ì ê¸ˆ';
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">ê¸ˆìœµ ê³„ì‚°ê¸°</h2>
                    
                    <div class="flex justify-around mb-6 bg-white p-2 rounded-full shadow-inner">
                        <button onclick="selectCalculator('ì ê¸ˆ')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === 'ì ê¸ˆ' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">ì ê¸ˆ</button>
                        <button onclick="selectCalculator('ì˜ˆê¸ˆ')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === 'ì˜ˆê¸ˆ' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">ì˜ˆê¸ˆ</button>
                        <button onclick="selectCalculator('ëŒ€ì¶œ')" class="flex-1 text-center py-2 rounded-full font-semibold transition ${currentCalc === 'ëŒ€ì¶œ' ? 'hyu-orange text-white' : 'text-gray-600 hover:bg-gray-100'}">ëŒ€ì¶œ</button>
                    </div>

                    <div id="calculator-form" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        </div>

                    <div id="calculator-result" class="p-5 bg-white rounded-xl shadow-inner text-center hidden mb-6">
                        </div>

                    <div class="mt-auto p-4 bg-white rounded-xl shadow-lg text-sm text-gray-600 border border-gray-100">
                        <p class="font-semibold mb-2 text-hyu-blue">ê³„ì‚°ê¸° ì´ìš© ìœ ì˜ ì‚¬í•­</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>ì„¸ê¸ˆ(ì´ìì†Œë“ì„¸ 15.4%)ì€ ê³„ì‚°ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</li>
                            <li>ì‹¤ì œ ê¸ˆìœµ ìƒí’ˆì˜ ì•½ê´€ì— ë”°ë¼ ê²°ê³¼ì™€ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Selects the calculator type and re-renders the form.
         * @param {string} type 'ì ê¸ˆ', 'ì˜ˆê¸ˆ', or 'ëŒ€ì¶œ'.
         */
        function selectCalculator(type) {
            sessionStorage.setItem('currentCalc', type);
            renderApp(); // Re-render to update nav and form
        }

        /**
         * Renders the dynamic calculator form.
         * @param {string} currentCalc 'ì ê¸ˆ', 'ì˜ˆê¸ˆ', or 'ëŒ€ì¶œ'.
         */
        function renderCalculatorForm(currentCalc) { // <--- ê³„ì‚°ê¸° ì˜¤ë¥˜ ìˆ˜ì • ë¶€ë¶„ (2/2)
            const formDiv = document.getElementById('calculator-form');
            if (!formDiv) return;
            
            let title = '';
            let formHtml = '';

            switch (currentCalc) {
                case 'ì ê¸ˆ':
                    title = 'ì ê¸ˆ (ììœ  ì ë¦½ì‹ - ë‹¨ìˆœ í•©ê³„)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">ë§¤ì›” ë‚©ì…ì•¡ (ì›)</label>
                        <input type="number" id="input-monthly" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="100000">
                        <label class="block mb-2 text-sm font-semibold">ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">
                        <label class="block mb-2 text-sm font-semibold">ì—° ì´ììœ¨ (%)</label>
                        <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.0">
                    `;
                    break;
                case 'ì˜ˆê¸ˆ':
                    title = 'ì˜ˆê¸ˆ (ë‹¨ë¦¬ - ë§Œê¸° ì§€ê¸‰)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">ì˜ˆê¸ˆ ì›ê¸ˆ (ì›)</label>
                        <input type="number" id="input-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="1000000">
                        <label class="block mb-2 text-sm font-semibold">ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">
                        <label class="block mb-2 text-sm font-semibold">ì—° ì´ììœ¨ (%)</label>
                        <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.0">
                    `;
                    break;
                case 'ëŒ€ì¶œ':
                    title = 'ëŒ€ì¶œ (ì›ë¦¬ê¸ˆ ê· ë“± ìƒí™˜)';
                    formHtml = `
                        <label class="block mb-2 text-sm font-semibold">ëŒ€ì¶œ ì›ê¸ˆ (ì›)</label>
                        <input type="number" id="input-loan-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="10000000">
                        <label class="block mb-2 text-sm font-semibold">ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number" id="input-loan-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="36">
                        <label class="block mb-2 text-sm font-semibold">ì—° ì´ììœ¨ (%)</label>
                        <input type="number" step="0.1" id="input-loan-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="5.5">
                    `;
                    break;
            }

            formDiv.innerHTML = `
                <h3 class="text-lg font-bold text-hyu-orange mb-4">${title}</h3>
                <div class="p-4 bg-white rounded-lg shadow space-y-3">
                    ${formHtml}
                    <button onclick="calculateFinance('${currentCalc}')" class="w-full hyu-blue text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                        ê²°ê³¼ ê³„ì‚°í•˜ê¸°
                    </button>
                </div>
            `;
        }

        /**
         * Calculates the financial result based on the current calculator form.
         * @param {string} currentCalc 'ì ê¸ˆ', 'ì˜ˆê¸ˆ', or 'ëŒ€ì¶œ'.
         */
        function calculateFinance(currentCalc) {
            const resultDiv = document.getElementById('calculator-result');
            let resultHtml = '';

            try {
                let totalInterest = 0;
                let totalAmount = 0;

                switch (currentCalc) {
                    case 'ì ê¸ˆ': // Installment Savings (Simple Interest - Monthly Basis)
                        const monthly = parseFloat(document.getElementById('input-monthly').value);
                        const months = parseInt(document.getElementById('input-months').value);
                        const rate = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (monthly <= 0 || months <= 0 || rate < 0 || isNaN(monthly) || isNaN(months) || isNaN(rate)) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");

                        // Total Principal
                        const principal = monthly * months;

                        // Calculate total interest using simple sum of monthly interest (sum of 1 to N months)
                        for (let i = 1; i <= months; i++) {
                            // Monthly principal * Annual Rate * (i / 12)
                            totalInterest += monthly * rate * ((months - i + 1) / 12);
                        }

                        totalAmount = principal + totalInterest;

                        // ìˆ˜ì •: toLocaleString() ì ìš©í•˜ì—¬ ê¸ˆì•¡ì— ì‰¼í‘œ(,) êµ¬ë¶„ì ì¶”ê°€
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">ì´ ìˆ˜ë ¹ì•¡: ${Math.round(totalAmount).toLocaleString()} ì›</p>
                            <p class="text-sm font-semibold text-gray-700">ì›ê¸ˆ í•©ê³„: ${Math.round(principal).toLocaleString()} ì›</p>
                            <p class="text-sm text-hyu-green">ì„¸ì „ ì´ì: ${Math.round(totalInterest).toLocaleString()} ì›</p>
                        `;
                        break;
                    case 'ì˜ˆê¸ˆ': // Fixed Deposit (Simple Interest - Annual Basis)
                        const principalE = parseFloat(document.getElementById('input-principal').value);
                        const monthsE = parseInt(document.getElementById('input-months').value);
                        const rateE = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (principalE <= 0 || monthsE <= 0 || rateE < 0 || isNaN(principalE) || isNaN(monthsE) || isNaN(rateE)) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");

                        totalInterest = principalE * rateE * (monthsE / 12);
                        totalAmount = principalE + totalInterest;

                        // ìˆ˜ì •: toLocaleString() ì ìš©í•˜ì—¬ ê¸ˆì•¡ì— ì‰¼í‘œ(,) êµ¬ë¶„ì ì¶”ê°€
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">ë§Œê¸° ìˆ˜ë ¹ì•¡: ${Math.round(totalAmount).toLocaleString()} ì›</p>
                            <p class="text-sm font-semibold text-gray-700">ì›ê¸ˆ: ${Math.round(principalE).toLocaleString()} ì›</p>
                            <p class="text-sm text-hyu-green">ì„¸ì „ ì´ì: ${Math.round(totalInterest).toLocaleString()} ì›</p>
                        `;
                        break;
                    case 'ëŒ€ì¶œ': // Loan (Equal Principal and Interest Payment - Monthly)
                        const principalL = parseFloat(document.getElementById('input-loan-principal').value);
                        const monthsL = parseInt(document.getElementById('input-loan-months').value);
                        const rateL = parseFloat(document.getElementById('input-loan-rate').value) / 100;

                        if (principalL <= 0 || monthsL <= 0 || rateL < 0 || isNaN(principalL) || isNaN(monthsL) || isNaN(rateL)) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");

                        const monthlyRate = rateL / 12;

                        if (monthlyRate === 0) {
                            // No interest
                            const monthlyPaymentNoInterest = principalL / monthsL;
                            totalInterest = 0;
                            resultHtml = `
                                <p class="text-xl font-bold text-hyu-blue mb-2">ë§¤ì›” ìƒí™˜ì•¡: ${Math.round(monthlyPaymentNoInterest).toLocaleString()} ì›</p>
                                <p class="text-sm font-semibold text-gray-700">ëŒ€ì¶œ ì›ê¸ˆ: ${principalL.toLocaleString()} ì›</p>
                                <p class="text-sm text-hyu-green">ì´ ì´ì: 0 ì›</p>
                            `;
                        } else {
                            // ì›ë¦¬ê¸ˆ ê· ë“± ìƒí™˜ ê³µì‹
                            const power = Math.pow(1 + monthlyRate, monthsL);
                            const monthlyPayment = principalL * (monthlyRate * power) / (power - 1);
                            
                            totalAmount = monthlyPayment * monthsL;
                            totalInterest = totalAmount - principalL;
                            
                            resultHtml = `
                                <p class="text-xl font-bold text-hyu-blue mb-2">ë§¤ì›” ìƒí™˜ì•¡: ${Math.round(monthlyPayment).toLocaleString()} ì›</p>
                                <p class="text-sm font-semibold text-gray-700">ì´ ìƒí™˜ì•¡: ${Math.round(totalAmount).toLocaleString()} ì›</p>
                                <p class="text-sm text-hyu-green">ì´ ì´ì: ${Math.round(totalInterest).toLocaleString()} ì›</p>
                            `;
                        }
                        break;
                }

                resultDiv.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Calculation Error:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
                resultDiv.classList.remove('hidden');
            }
        }

        // #009 HYUFA ê³ ê°ì„¼í„°
        function renderCustomerCenter() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA ê³ ê°ì„¼í„°</h2>

                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">ìì£¼ í•˜ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ì´ë™</h3>
                        <p class="text-sm text-gray-600 mb-4">ë§ì€ ì´ìš©ìë“¤ì´ ê¶ê¸ˆí•´í•˜ëŠ” ì§ˆë¬¸ì€ FAQì—ì„œ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="setAppState('FAQ')" class="w-full hyu-orange text-white font-bold py-3 rounded-lg shadow-md hover:opacity-90 transition">
                            <i class="fa-solid fa-circle-question mr-2"></i> FAQ ë°”ë¡œê°€ê¸°
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">ì „í™” ìƒë‹´ ì•ˆë‚´</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            ê¸ˆìœµ ìƒë‹´ì´ í•„ìš”í•˜ì‹  ê²½ìš°, í‰ì¼ ì—…ë¬´ ì‹œê°„ ë‚´ì— ì—°ë½ì£¼ì‹œë©´ ì „ë¬¸ ìƒë‹´ì›ì„ ì—°ê²°í•´ ë“œë¦½ë‹ˆë‹¤.
                        </p>
                        <div class="flex items-center justify-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fa-solid fa-phone-volume text-3xl text-hyu-blue mr-4"></i>
                            <a href="tel:02-2220-0000" class="text-2xl font-bold text-hyu-blue hover:text-hyu-orange transition">
                                02-2220-0000
                            </a>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            * ë³¸ ì „í™”ë²ˆí˜¸ëŠ” í•œì–‘ëŒ€í•™êµ ëŒ€í‘œ ì „í™”ë²ˆí˜¸ë¥¼ ê°€ì •í•œ ì„ì‹œ ë²ˆí˜¸ì…ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            `;
        }

        // #0010 HYUFA ì˜ê²¬ ë‚¨ê¸°ê¸°
        function renderFeedback() {
            // Expose submitFeedback to global scope
            window.submitFeedback = submitFeedback;
            window.setRating = setRating;
            
            let currentRating = 0;

            // Rating logic inside the component to manage state better
            function setRating(rating) {
                currentRating = rating;
                document.querySelectorAll('#rating-stars i').forEach((star) => {
                    const starRating = parseInt(star.getAttribute('data-rating'));
                    if (starRating <= rating) {
                        star.style.color = '#88774F'; // HYU Gold
                    } else {
                        star.style.color = '#ccc';
                    }
                });
            }

            async function submitFeedback() {
                const text = document.getElementById('feedback-text').value.trim();
                
                if (currentRating === 0 || text === '') {
                    showMessage("ë³„ì ê³¼ ì˜ê²¬ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    const feedbackData = {
                        userId: userId,
                        rating: currentRating,
                        feedback: text,
                        timestamp: serverTimestamp() 
                    };

                    // Assuming 'artifacts' is a top-level collection and we store public data inside it
                    const feedbackRef = collection(db, 'artifacts', appId, 'public', 'data', 'feedback');
                    await addDoc(feedbackRef, feedbackData);

                    showMessage("ì†Œì¤‘í•œ ì˜ê²¬ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!");
                    setAppState('MAIN_CHAT');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("ì†Œì¤‘í•œ ì˜ê²¬ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. <br> ê°ì‚¬í•©ë‹ˆë‹¤!");
                }
            }
            
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA ì˜ê²¬ ë‚¨ê¸°ê¸°</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">ì†Œì¤‘í•œ ì˜ê²¬ìœ¼ë¡œ ë˜‘ë˜‘í•œ HYUFAê°€ ë˜ê² ìŠµë‹ˆë‹¤.</h3>

                        <div id="rating-stars" class="flex justify-center text-4xl text-gray-300 space-x-1 mb-6">
                            ${[1, 2, 3, 4, 5].map(i => `
                                <i class="fa-solid fa-star cursor-pointer hover:text-hyu-gold transition duration-150" data-rating="${i}" onclick="setRating(${i})"></i>
                            `).join('')}
                        </div>

                        <textarea id="feedback-text" rows="5" placeholder="HYUFAì—ê²Œ ë°”ë¼ëŠ” ì , ê°œì„ í•  ì  ë“± ììœ ë¡­ê²Œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”." class="w-full p-4 border border-gray-300 rounded-lg focus:ring-hyu-blue focus:border-hyu-blue mb-6 resize-none"></textarea>

                        <button onclick="submitFeedback()" class="w-full hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            ì˜ê²¬ ì œì¶œí•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
        }


        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <i class="fa-solid fa-circle-notch fa-spin text-5xl text-hyu-blue mb-4"></i>
                    <p class="text-xl font-semibold text-gray-700">ì„œë¹„ìŠ¤ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-sm text-hyu-silver mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // --- 6. Initialization ---

        window.onload = async () => {
            // 1) FAQ ë°ì´í„° ë¡œë“œ
            await loadFAQData();

            // 2) ê¸°ëŒ€ìˆ˜ìµë¥  JSON ë¡œë“œí•´ì„œ currentPortfolio.rate ì—…ë°ì´íŠ¸
            await loadExpectedReturns();
            console.log("ìµœì¢… currentPortfolio", currentPortfolio); 

            // 3) Firebase ì´ˆê¸°í™”
            await initializeFirebase();

            // 4) í¬íŠ¸í´ë¦¬ì˜¤ í¸ì§‘ í™”ë©´ì´ë©´ ì´í•©ê³„ í‘œì‹œ
            if (appState === 'PORTFOLIO_EDIT') {
                checkPortfolioTotal();
            }
        };

        // Expose top-level functions to global scope for HTML onclick
        window.setAppState = setAppState;
        window.handleConsent = handleConsent;
        window.renderCalculatorForm = renderCalculatorForm; // Expose for calculator logic
        window.renderGoalSettingForm = renderGoalSettingForm; // Expose for goal setting logic
        
    </script>
</body>
</html>





