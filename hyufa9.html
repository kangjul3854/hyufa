<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYUFA 금융 비서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 수정: Noto Sans KR 폰트 임포트 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        body {
            /* 수정: font-family를 Noto Sans KR로 변경 */
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        /* HYU Color Palette */
        .hyu-blue { background-color: #0E4A84; }
        .text-hyu-blue { color: #0E4A84; }
        .border-hyu-blue { border-color: #0E4A84; }
        .hyu-silver { background-color: #898C8E; }
        .hyu-green { background-color: #7DB928; }
        .hyu-orange { background-color: #F08100; }
        .hyu-coral { background-color: #FF8672; }
        /* HYU Gold added for feedback stars */
        .hyu-gold { color: #88774F; }


        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-track {
            background-color: #f7fafc;
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="app-container" class="w-full max-w-md h-[90vh] bg-white shadow-2xl rounded-xl flex flex-col overflow-y-auto">
        </div>

    <script type="module">
        // --- 1. Firebase & Global Variable Setup ---

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API key for Gemini

        // Firebase Imports (MUST use CDN URLs)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Gemini API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // **수정: 새로운 systemPrompt가 적용되었습니다.**
        const systemPrompt = `
당신은 대학생·사회초년생을 위한 '은행 금융상담 챗봇'입니다.

[역할]
- 당신은 은행 창구 직원 또는 PB처럼 전문적이고 신뢰감 있는 말투를 사용합니다.
- 다만 상대는 금융이 익숙하지 않은 20대이므로, 어려운 용어는 풀어서 쉽게 설명합니다.
- 투자상품을 '권유'하거나, '수익을 보장'하는 표현은 절대 사용하지 않습니다.

[지식 활용 원칙]
- 사용자가 질문하면, 먼저 제공된 Knowledge(JSON)의 질문·답변 목록에서 의미상 가장 가까운 항목을 찾습니다.
- 찾은 항목의 'answer' 내용을 기반으로, 4~6줄 분량의 대화형 설명으로 재구성하여 답변합니다.
- Knowledge에 해당 내용이 전혀 없다고 판단되면, 다음과 같이 답합니다.
  → "해당 내용은 제가 가지고 있는 자료에 없어요. 다른 금융 질문을 해주시면 도와드릴게요."

[답변 스타일]
1) 한 번의 답변은 4~6줄 정도의 길이로, 핵심만 명확하게 전달합니다.
2) "~예요, ~합니다"와 같은 공손하고 부드러운 말투를 사용합니다.
3) 리스크가 있는 내용(투자, 대출 등)은 장단점을 함께 설명하고, 최종 선택은 사용자에게 맡깁니다.
4) 사용자의 상황을 가볍게 되물어보며(필요할 때만), 더 도움이 될 수 있는 추가 정보를 제안합니다.

이 규칙을 모든 답변에서 일관되게 적용합니다.
`;

        // Application State
        let appState = 'LOADING'; // WELCOME, CONSENT, MAIN_CHAT, MENU, GUIDE, FAQ, PORTFOLIO, CALCULATOR, CUSTOMER_CENTER, FEEDBACK
        let db;
        let auth;
        let userId = null;
        let chatHistory = [];
        let faqData = [];
        let isChatLoading = false;

        // --- 2. Utility Functions ---

        /**
         * Simple function to set the application state and re-render.
         * @param {string} newState The new state to set.
         */
        function setAppState(newState) {
            appState = newState;
            renderApp();
        }

        /**
         * Display a message box (replacement for alert/confirm).
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            const container = document.getElementById('app-container');
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs text-center">
                    <p class="text-gray-700 font-semibold mb-4">${message}</p>
                    <button id="close-msg" class="w-full hyu-blue text-white py-2 rounded-lg font-bold">확인</button>
                </div>
            `;
            container.appendChild(overlay);

            document.getElementById('close-msg').onclick = () => {
                container.removeChild(overlay);
            };
        }

        // --- 3. Data & Firebase Setup ---

        /**
         * Initialize Firebase, sign in, and set up state.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                setAppState('WELCOME'); // Fallback to welcome if config is missing
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use initial auth token if provided, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase signed in. User ID:", userId);

                        // Check for consent (simulate simple session consent check)
                        if (localStorage.getItem('hyufa_consent') === 'agreed') {
                            setAppState('MAIN_CHAT');
                        } else {
                            setAppState('WELCOME');
                        }
                    } else {
                        userId = 'anonymous';
                        console.warn("Firebase signed out. Using anonymous ID.");
                        setAppState('WELCOME');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("Firebase 연결에 실패했습니다. (Error: " + error.code + ")");
                setAppState('WELCOME');
            }
        }

        /**
         * Load FAQ data from the uploaded JSON file.
         */
        async function loadFAQData() {
            try {
                // Simulate fetch of the uploaded file content
                const contentId = "uploaded:finance_chatbot_knowledge_104qa.json";
                const response = await fetch(`/api/files/download?contentFetchId=${contentId}`);
                if (!response.ok) throw new Error('Failed to fetch FAQ data');

                faqData = await response.json();
                console.log(`Loaded ${faqData.length} FAQ items.`);

            } catch (error) {
                console.error("Error loading FAQ data:", error);
                faqData = [
                    { category: "오류", question: "FAQ 로딩 실패", answer: "FAQ 데이터를 불러오는 데 실패했습니다. 콘솔을 확인해주세요." },
                    // Mock data if file loading fails
                    { category: "1. 금융 상식", question: "예·적금 차이", answer: "예금은 언제든지 넣고 뺄 수 있는 대신 금리가 낮고, 적금은 매달 일정 금액을 넣는 대신 금리가 조금 더 높아요." }
                ];
            }
        }

        // --- 4. Gemini API Logic ---

        /**
         * Calls the Gemini API for chat response.
         * @param {string} prompt The user's query.
         */
        async function askHYUFA(prompt) {
            if (isChatLoading) return;

            // 1. Add user message to history
            const chatHistoryElement = document.getElementById('chat-history');
            if (!chatHistoryElement) return;

            chatHistory.push({ sender: 'user', text: prompt });
            renderChatHistory();

            // 2. Add loading message
            chatHistory.push({ sender: 'ai', text: '... 답변을 생성 중입니다.', loading: true });
            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
            isChatLoading = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

            // Prepare history for API call (excluding the temporary loading message)
            const apiContents = chatHistory.slice(0, -1).map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            // Add the new user prompt
            apiContents.push({
                role: 'user',
                parts: [{ text: prompt }]
            });


            const payload = {
                contents: apiContents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // 3. API Call with Exponential Backoff
            let responseText = "죄송합니다. 서비스에 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            responseText = candidate.content.parts[0].text;
                        } else {
                            responseText = "답변을 생성하지 못했습니다. 다시 시도해주세요.";
                        }
                        break; // Success
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`API Call failed (Attempt ${retryCount + 1}):`, error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // 4. Update history with final response
            const loadingIndex = chatHistory.findIndex(msg => msg.loading);
            if (loadingIndex !== -1) {
                chatHistory.splice(loadingIndex, 1); // Remove loading message
            }
            chatHistory.push({ sender: 'ai', text: responseText });
            isChatLoading = false;

            renderChatHistory();
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }


        // --- 5. View Rendering Logic ---

        /**
         * Renders the chat history messages.
         */
        function renderChatHistory() {
            const historyDiv = document.getElementById('chat-history');
            if (!historyDiv) return;
            historyDiv.innerHTML = chatHistory.map(msg => `
                <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-xs sm:max-w-sm lg:max-w-md p-3 rounded-xl shadow-md ${
                        // 수정: 사용자 메시지 (user)의 배경을 흰색/옅은 회색, 텍스트를 검정색(text-gray-800)으로 변경
                        msg.sender === 'user'
                            ? 'bg-gray-200 text-gray-800 rounded-br-none'
                            : 'bg-gray-100 text-gray-800 rounded-tl-none'
                    }">
                        ${msg.loading ? '<i class="fa-solid fa-spinner fa-spin-pulse mr-2"></i>' : ''}
                        <p class="whitespace-pre-wrap">${msg.text}</p>
                    </div>
                </div>
            `).join('');
        }


        /**
         * Renders the main HYUFA application shell.
         */
        function renderApp() {
            const container = document.getElementById('app-container');

            // 1. Render Header (Always present on chat/menu screens)
            const header = `
                <div class="hyu-blue p-4 text-white shadow-lg flex justify-between items-center">
                    <h1 class="text-xl font-bold">HYUFA</h1>
                    ${appState !== 'WELCOME' && appState !== 'CONSENT' ? `
                        <button onclick="setAppState('MAIN_CHAT')" class="text-sm border border-white px-3 py-1 rounded-full hover:bg-white hover:text-hyu-blue transition">
                            <i class="fa-solid fa-house"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            container.innerHTML = header;

            // 2. Render Content based on state
            let content;
            switch (appState) {
                case 'WELCOME':
                    content = renderWelcome();
                    break;
                case 'CONSENT':
                    content = renderConsent();
                    break;
                case 'MAIN_CHAT':
                    content = renderMainChat();
                    break;
                case 'MENU':
                    content = renderMenu();
                    break;
                case 'GUIDE':
                    content = renderGuide();
                    break;
                case 'FAQ':
                    content = renderFAQ();
                    break;
                case 'PORTFOLIO':
                    content = renderPortfolio();
                    break;
                case 'CALCULATOR':
                    content = renderCalculator();
                    break;
                case 'CUSTOMER_CENTER':
                    content = renderCustomerCenter();
                    break;
                case 'FEEDBACK':
                    content = renderFeedback();
                    break;
                case 'LOADING':
                default:
                    content = renderLoading();
                    break;
            }
            container.innerHTML += content;

            // Post-render actions for specific screens
            if (appState === 'MAIN_CHAT') {
                renderChatHistory();
                const chatHistoryElement = document.getElementById('chat-history');
                if(chatHistoryElement) {
                    chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
                }
            } else if (appState === 'FAQ') {
                setupFAQToggle();
            }
        }

        // --- View Specific HTML Generation ---

        // #001 첫 화면
        function renderWelcome() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <div class="text-7xl mb-4" style="color: #F08100;">
                        <i class="fa-solid fa-piggy-bank"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-hyu-blue mb-2">반갑습니다.</h2>
                    <p class="text-2xl font-bold text-gray-700 mb-8">HYUFA 입니다.</p>
                    <button onclick="setAppState('CONSENT')" class="hyu-blue text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-opacity-90 transition transform hover:scale-105">
                        서비스 시작하기
                    </button>
                </div>
            `;
        }

        // #002 팝업 전환 (개인정보 수집 및 이용 동의)
        function renderConsent() {
             return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">개인정보 수집 및 이용 동의</h2>

                    <p class="text-sm text-gray-700 mb-4">
                        고객님의 상담 업무를 처리하기 위해서는 개인정보보호법 제 15조 1항에 따라 아래의 내용에 대하여 고객님의 동의가 필요합니다.
                    </p>

                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-inner mb-6 text-sm space-y-3">
                        <p><strong>1. 개인정보의 수집 이용 목적</strong><br>- 서비스 이용에 따른 상담 업무 처리</p>
                        <p><strong>2. 수집하려는 개인정보의 항목</strong><br>- 챗봇 상담내용</p>
                        <p><strong>3. 개인정보의 보유 및 이용 기간</strong><br>- 위 개인정보는 수집 이용에 관한 동의 이후 처리 종료일로부터 2년간 위 이용목적을 위하여 보유/이용됩니다.</p>
                        <p class="text-xs text-hyu-orange"><strong>4. 안내사항</strong><br>- 동의를 거부할 권리가 있으며, 거부 시 상담에 제한될 수 있습니다.</p>
                    </div>

                    <div class="flex space-x-4 mt-auto pt-4 border-t">
                        <button onclick="handleConsent(true)" class="flex-1 hyu-blue text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            동의
                        </button>
                        <button onclick="handleConsent(false)" class="flex-1 hyu-silver text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                            비동의 (나가기)
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Handle consent action.
         * @param {boolean} agreed True if agreed, false otherwise.
         */
        function handleConsent(agreed) {
            if (agreed) {
                localStorage.setItem('hyufa_consent', 'agreed');
                if (chatHistory.length === 0) {
                     chatHistory.push({ sender: 'ai', text: `안녕하세요.\n인공지능 HYUFA입니다.\n무엇을 도와드릴까요?\n\n+ 버튼을 눌러 이용 안내를 확인해보세요.` });
                }
                setAppState('MAIN_CHAT');
            } else {
                showMessage("서비스 이용을 위해 동의가 필요합니다. 창을 닫습니다.");
                // In a real application, this would close the widget/iframe. Here we navigate back to welcome.
                setAppState('WELCOME');
            }
        }


        // #003 MAIN 화면
        function renderMainChat() {
            const today = new Date();
            // 수정: 날짜 포맷을 'YYYY.MM.DD(요일)' 형식으로 변경 (2025.11.19.(수) 형식)
            const dateStr = today.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                weekday: 'short' 
            }).replace(/\.\s/g, '.').replace(/\.$/, '');

            return `
                <div class="flex flex-col flex-grow relative">
                    <div class="p-4 bg-gray-50 border-b border-gray-200 text-center">
                        <p class="text-xs text-hyu-silver">${dateStr}</p>
                        ${chatHistory.length === 0 ? `
                        <div class="text-center mt-2">
                            <p class="text-lg font-semibold text-gray-700">안녕하세요.</p>
                            <p class="text-xl font-bold text-hyu-blue">인공지능 HYUFA입니다.</p>
                            <p class="text-md text-gray-600 mt-1">무엇을 도와드릴까요?</p>
                        </div>
                        ` : ''}
                    </div>

                    <div id="chat-history" class="flex-grow p-4 overflow-y-auto bg-white">
                        </div>

                    <div class="p-4 bg-gray-100 border-t border-gray-200 flex items-center">
                        <button onclick="setAppState('MENU')" class="text-hyu-blue text-3xl mr-3 hover:opacity-75 transition">
                            <i class="fa-solid fa-circle-plus"></i>
                        </button>
                        <input id="chat-input" type="text" placeholder="궁금한 사항을 입력해주세요." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:border-hyu-blue">
                        <button id="send-button" onclick="handleChatSubmit()" class="hyu-blue text-white py-2 px-4 ml-3 rounded-full font-bold hover:bg-opacity-90 transition">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Handle chat input submission (Enter or Send button).
         */
        function handleChatSubmit() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (prompt && !isChatLoading) {
                input.value = '';
                askHYUFA(prompt);
            }
        }

        // Add Enter key listener once the DOM is ready for chat
        document.addEventListener('keydown', (e) => {
            if (appState === 'MAIN_CHAT' && e.key === 'Enter') {
                handleChatSubmit();
            }
        });


        // #004 + 화면 (Menu)
        function renderMenu() {
            const menuItems = [
                { name: 'HYUFA 이용 안내', state: 'GUIDE', icon: 'fa-circle-info' },
                { name: '자주하는 질문', state: 'FAQ', icon: 'fa-circle-question' },
                { name: '포트폴리오 추천', state: 'PORTFOLIO', icon: 'fa-chart-pie' },
                { name: '금융 계산기', state: 'CALCULATOR', icon: 'fa-calculator' },
                { name: 'HYUFA 고객센터', state: 'CUSTOMER_CENTER', icon: 'fa-headset' },
                { name: 'HYUFA 의견 남기기', state: 'FEEDBACK', icon: 'fa-comment-dots' },
            ];

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">서비스 메뉴</h2>
                    <div class="space-y-3">
                        ${menuItems.map(item => `
                            <button onclick="setAppState('${item.state}')"
                                class="w-full text-left flex items-center p-4 bg-white rounded-xl shadow hover:shadow-md transition transform hover:translate-y-[-1px]">
                                <i class="fa-solid ${item.icon} text-2xl mr-4" style="color: #7DB928;"></i>
                                <span class="text-lg font-semibold text-gray-700">${item.name}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // #005 HYUFA 이용 안내
        function renderGuide() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 이용 안내</h2>

                    <div class="space-y-6 text-gray-700">
                        <section>
                            <h3 class="text-xl font-bold text-hyu-green mb-2 flex items-center"><i class="fa-solid fa-star mr-2"></i> 여러분의 AI 금융 비서 HYUFA</h3>
                            <p class="text-sm">HYUFA는 간단한 금융 상식부터 포트폴리오 추천까지 대학생 및 사회초년생을 위한 금융 상담을 도와드리고 있어요.</p>
                        </section>

                        <section>
                            <h3 class="text-xl font-bold text-hyu-green mb-2 flex items-center"><i class="fa-solid fa-lightbulb mr-2"></i> 어떤 금융 상담을 받을 수 있나요?</h3>
                            <p class="text-sm">처음 접해보는 금융에 어려움을 느끼지 않도록 기본적인 금융 상식에 대해 알려주고, 여러분들의 투자 성향에 맞게 포트폴리오를 추천해드립니다.</p>
                        </section>

                        <section>
                            <h3 class="text-xl font-bold text-hyu-green mb-2 flex items-center"><i class="fa-solid fa-money-check-dollar mr-2"></i> 어떤 금융 상품이 가능한가요?</h3>
                            <p class="text-sm">여러분들의 투자 성향에 대해 먼저 분석한 후, 안전자산 (예.적금)과 위험자산 (ETF)로 나누어 개인화된 상담을 제공합니다.</p>
                        </section>

                        <section class="bg-hyu-coral bg-opacity-10 p-4 rounded-lg border border-hyu-coral">
                            <h3 class="text-lg font-bold text-hyu-blue mb-2 flex items-center"><i class="fa-solid fa-circle-exclamation mr-2"></i> 이용시 유의사항</h3>
                            <ul class="text-sm list-disc pl-5 space-y-1">
                                <li>HYUFA에게 짧고 간단한 핵심만 질문해주세요 !</li>
                                <li>본 서비스는 ‘인간-인공지능 협업 제품 서비스 설계’ 수업 팀 프로젝트로, 사전 설계한 프롬프트 기반으로 작동합니다.</li>
                                <li>따라서 상용 AI만큼의 응답 유연성에는 일부 제한이 있으며, 본 챗봇은 사용자 경험 검증과 서비스 콘셉트 제시 목적으로 제작되었습니다.</li>
                            </ul>
                            <p class="text-center mt-3 text-sm font-semibold text-hyu-coral">
                                그래도 처음 금융을 접할 때 느끼는 막막함을 덜어드리기 위해 설계한 서비스로 많은 이용 부탁드립니다 ♥︎
                            </p>
                        </section>
                    </div>
                </div>
            `;
        }

        // #006 자주하는 질문
        function renderFAQ() {
            const categories = [...new Set(faqData.map(item => item.category))].sort();

            const faqList = categories.map(category => {
                const items = faqData.filter(item => item.category === category);
                const itemsHtml = items.map((item, index) => `
                    <div class="border-b last:border-b-0">
                        <button class="faq-question w-full text-left py-3 px-4 font-semibold text-gray-700 hover:bg-gray-50 transition flex justify-between items-center" data-index="${category}-${index}">
                            ${item.question}
                            <i class="fa-solid fa-chevron-down text-xs ml-2 transition-transform duration-300"></i>
                        </button>
                        <div id="answer-${category}-${index}" class="faq-answer max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-gray-50 px-4">
                            <div class="py-3 text-sm text-gray-600 whitespace-pre-wrap">${item.answer}</div>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="mb-6 bg-white rounded-xl shadow-lg overflow-hidden">
                        <h3 class="text-xl font-bold p-4 border-b text-hyu-orange bg-gray-100">${category}</h3>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">자주하는 질문 (FAQ)</h2>
                    ${faqList}
                </div>
            `;
        }

        /**
         * Setup toggle logic for FAQ accordion.
         */
        function setupFAQToggle() {
            document.querySelectorAll('.faq-question').forEach(button => {
                button.onclick = function() {
                    const id = this.getAttribute('data-index');
                    const answerDiv = document.getElementById(`answer-${id}`);
                    const icon = this.querySelector('i');

                    // Check if it's currently open
                    const isOpen = answerDiv.classList.contains('active');

                    // Close all others
                    document.querySelectorAll('.faq-answer').forEach(div => {
                        div.classList.remove('active');
                        div.style.maxHeight = '0';
                        div.style.paddingTop = '0';
                        div.style.paddingBottom = '0';
                    });
                    document.querySelectorAll('.faq-question i').forEach(i => {
                        i.classList.remove('rotate-180');
                    });

                    // Toggle current one
                    if (!isOpen) {
                        answerDiv.classList.add('active');
                        const innerContent = answerDiv.querySelector('div');
                        // Set max height to content height + padding to allow transition
                        answerDiv.style.maxHeight = innerContent.scrollHeight + 30 + 'px';
                        answerDiv.style.paddingTop = '0.75rem'; // py-3
                        answerDiv.style.paddingBottom = '0.75rem'; // py-3
                        icon.classList.add('rotate-180');
                    }
                };
            });
        }


        // #007 포트폴리오 추천
        function renderPortfolio() {
            const mockPortfolio = [
                { name: '안전자산 (적금)', color: 'hyu-green', percentage: 30, description: '단기/비상 자금 확보 및 안정적 수익 추구' },
                { name: '위험자산 (나스닥 100 ETF)', color: 'hyu-orange', percentage: 50, description: '미국 기술주 중심의 고성장 수익 추구' },
                // Mock gold color
                { name: '위험자산 (금 ETF)', color: 'hyu-gold', percentage: 20, description: '인플레이션 헤지 및 포트폴리오 안정화' },
            ];
            
            // Utility function to get tailwind color class name from mock color name
            const getColorClass = (mockColor) => {
                switch (mockColor) {
                    case 'hyu-green': return 'green-500';
                    case 'hyu-orange': return 'orange-500';
                    case 'hyu-gold': return 'amber-700';
                    default: return 'gray-500';
                }
            };


            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">포트폴리오 추천</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <p class="text-lg font-semibold mb-4 text-center">나의 투자 성향 분석 결과: <span class="text-hyu-orange">공격 투자형</span></p>
                        <p class="text-sm text-gray-600 mb-6 text-center">
                            * 포트폴리오 추천은 단순 예시이며, 실제 투자는 개인의 책임 하에 이루어져야 합니다.
                        </p>

                        <div class="w-full flex justify-center mb-6">
                            <div class="w-36 h-36 rounded-full relative" style="background: conic-gradient(
                                    #7DB928 0% 30%, 
                                    #F08100 30% 80%, 
                                    #88774F 80% 100%
                                ); box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                                <div class="absolute inset-4 bg-white rounded-full flex items-center justify-center">
                                    <span class="text-2xl font-bold text-hyu-blue">100%</span>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            ${mockPortfolio.map(item => `
                                <div class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-[${item.color.split('-')[1]}]">
                                    <div class="w-1/4">
                                        <div class="font-bold text-md text-gray-800">${item.name}</div>
                                    </div>
                                    <div class="w-1/4 text-center">
                                        <div class="text-xl font-extrabold" style="color: ${item.color === 'hyu-green' ? '#7DB928' : item.color === 'hyu-orange' ? '#F08100' : '#88774F'}">${item.percentage}%</div>
                                    </div>
                                    <div class="w-1/2 text-sm text-gray-600 ml-4">
                                        ${item.description}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // #008 금융 계산기
        function renderCalculator() {
            const calcTypes = ['적금', '예금', '대출'];
            let currentCalc = '적금'; // Default

            function setCalcType(type) {
                currentCalc = type;
                document.querySelectorAll('.calc-type-button').forEach(btn => {
                    btn.classList.remove('hyu-blue', 'text-white', 'shadow-md');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                const selectedBtn = document.getElementById(`calc-btn-${type}`);
                selectedBtn.classList.add('hyu-blue', 'text-white', 'shadow-md');
                selectedBtn.classList.remove('bg-gray-200', 'text-gray-700');
                renderCalcForm();
            }

            function renderCalcForm() {
                const formDiv = document.getElementById('calc-form-container');
                let formHtml = '';
                let title = '';

                switch (currentCalc) {
                    case '적금':
                        title = '적금 (월 납입액 기준)';
                        formHtml = `
                            <label class="block mb-2 text-sm font-semibold">월 납입액 (원)</label>
                            <input type="number" id="input-monthly" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="100000">

                            <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                            <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">

                            <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                            <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.5">
                        `;
                        break;
                    case '예금':
                        title = '예금 (총액 기준)';
                        formHtml = `
                            <label class="block mb-2 text-sm font-semibold">총 예치 금액 (원)</label>
                            <input type="number" id="input-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="5000000">

                            <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                            <input type="number" id="input-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="12">

                            <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                            <input type="number" step="0.1" id="input-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="3.0">
                        `;
                        break;
                    case '대출':
                        title = '대출 (원리금 균등 상환)';
                        formHtml = `
                            <label class="block mb-2 text-sm font-semibold">대출 원금 (원)</label>
                            <input type="number" id="input-loan-principal" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="10000000">

                            <label class="block mb-2 text-sm font-semibold">기간 (개월)</label>
                            <input type="number" id="input-loan-months" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="36">

                            <label class="block mb-2 text-sm font-semibold">연 이자율 (%)</label>
                            <input type="number" step="0.1" id="input-loan-rate" class="w-full p-2 mb-4 border rounded-lg focus:ring-hyu-blue focus:border-hyu-blue" value="5.5">
                        `;
                        break;
                }

                formDiv.innerHTML = `
                    <h3 class="text-lg font-bold text-hyu-orange mb-4">${title}</h3>
                    <div class="p-4 bg-white rounded-lg shadow space-y-3">
                        ${formHtml}
                        <button onclick="calculateFinance('${currentCalc}')" class="w-full hyu-blue text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                            결과 계산하기
                        </button>
                    </div>
                    <div id="calc-result" class="mt-4 p-4 bg-white rounded-xl shadow-lg border-t-4 border-hyu-green hidden">
                        </div>
                `;
            }

            // Expose utility functions to the global scope for onclick handlers
            window.setCalcType = setCalcType;
            window.renderCalcForm = renderCalcForm;
            window.calculateFinance = calculateFinance;

            // Initial rendering
            setTimeout(() => {
                setCalcType('적금');
            }, 0);

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">금융 계산기</h2>

                    <div class="flex justify-between mb-6 bg-white p-2 rounded-xl shadow">
                        ${calcTypes.map(type => `
                            <button id="calc-btn-${type}" onclick="setCalcType('${type}')"
                                class="calc-type-button flex-1 py-2 rounded-lg font-semibold transition">
                                ${type}
                            </button>
                        `).join('')}
                    </div>

                    <div id="calc-form-container">
                        </div>
                </div>
            `;
        }

        /**
         * Performs the financial calculation based on the type.
         * @param {string} type The type of calculation (적금, 예금, 대출).
         */
        function calculateFinance(type) {
            let resultHtml = '';
            const resultDiv = document.getElementById('calc-result');
            resultDiv.classList.add('hidden');

            try {
                let totalAmount = 0;
                let totalInterest = 0;

                switch (type) {
                    case '적금': // Installment Savings (Simple Interest - Monthly Basis)
                        const monthly = parseFloat(document.getElementById('input-monthly').value);
                        const months = parseInt(document.getElementById('input-months').value);
                        const rate = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (monthly <= 0 || months <= 0 || rate < 0) throw new Error("유효하지 않은 입력값입니다.");

                        // Simple monthly installment savings calculation (단리)
                        const monthlyRate = rate / 12;
                        const principal = monthly * months;
                        for (let i = 1; i <= months; i++) {
                            // (Total Months - Month paid + 1) * monthlyRate * monthly payment
                            totalInterest += monthly * monthlyRate * i;
                        }
                        totalAmount = principal + totalInterest;

                        // 수정: toLocaleString() 적용하여 금액에 쉼표(,) 구분자 추가
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">총 수령액: ${Math.round(totalAmount).toLocaleString()} 원</p>
                            <p class="text-sm font-semibold text-gray-700">원금 합계: ${Math.round(principal).toLocaleString()} 원</p>
                            <p class="text-sm text-hyu-green">세전 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                        `;
                        break;

                    case '예금': // Fixed Deposit (Simple Interest - Annual Basis)
                        const principalE = parseFloat(document.getElementById('input-principal').value);
                        const monthsE = parseInt(document.getElementById('input-months').value);
                        const rateE = parseFloat(document.getElementById('input-rate').value) / 100;

                        if (principalE <= 0 || monthsE <= 0 || rateE < 0) throw new Error("유효하지 않은 입력값입니다.");

                        totalInterest = principalE * rateE * (monthsE / 12);
                        totalAmount = principalE + totalInterest;

                        // 수정: toLocaleString() 적용하여 금액에 쉼표(,) 구분자 추가
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">만기 수령액: ${Math.round(totalAmount).toLocaleString()} 원</p>
                            <p class="text-sm font-semibold text-gray-700">원금: ${Math.round(principalE).toLocaleString()} 원</p>
                            <p class="text-sm text-hyu-green">세전 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                        `;
                        break;

                    case '대출': // Loan (Equal Principal and Interest Payment - Monthly)
                        const principalL = parseFloat(document.getElementById('input-loan-principal').value);
                        const monthsL = parseInt(document.getElementById('input-loan-months').value);
                        const rateL = parseFloat(document.getElementById('input-loan-rate').value) / 100;

                        if (principalL <= 0 || monthsL <= 0 || rateL < 0) throw new Error("유효하지 않은 입력값입니다.");

                        const monthlyRateL = rateL / 12;
                        let monthlyPayment = 0;
                        if (monthlyRateL === 0) {
                            monthlyPayment = principalL / monthsL;
                            totalInterest = 0;
                        } else {
                            // Monthly payment formula (원리금 균등 상환)
                            monthlyPayment = principalL * monthlyRateL * (Math.pow(1 + monthlyRateL, monthsL) / (Math.pow(1 + monthlyRateL, monthsL) - 1));
                            totalAmount = monthlyPayment * monthsL;
                            totalInterest = totalAmount - principalL;
                        }

                        // 수정: toLocaleString() 적용하여 금액에 쉼표(,) 구분자 추가
                        resultHtml = `
                            <p class="text-xl font-bold text-hyu-blue mb-2">월 상환액: ${Math.round(monthlyPayment).toLocaleString()} 원</p>
                            <p class="text-sm font-semibold text-gray-700">총 납입 원금: ${Math.round(principalL).toLocaleString()} 원</p>
                            <p class="text-sm text-hyu-coral">총 이자: ${Math.round(totalInterest).toLocaleString()} 원</p>
                            <p class="text-xs mt-2 text-gray-500">* 계산은 세금 및 수수료가 제외된 단순 추정치입니다.</p>
                        `;
                        break;
                }
                resultDiv.innerHTML = resultHtml;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                showMessage(`계산 오류: ${error.message}`);
                console.error("Calculation Error:", error);
            }
        }


        // #009 HYUFA 고객센터
        function renderCustomerCenter() {
            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 고객센터</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <i class="fa-solid fa-phone-volume text-6xl text-hyu-green mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">HYUFA 고객센터 안내드립니다.</h3>
                        <p class="text-4xl font-extrabold text-hyu-blue mb-4">02-2220-1111</p>
                        <div class="border-t pt-4">
                            <p class="text-lg font-semibold text-gray-700">운영 시간 안내</p>
                            <p class="text-xl font-bold text-hyu-orange">365일 24시간</p>
                        </div>
                        <p class="text-sm mt-4 text-gray-500">
                            * 본 전화번호는 한양대학교 대표 전화번호를 가정한 임시 번호입니다.
                        </p>
                    </div>
                </div>
            `;
        }

        // #0010 HYUFA 의견 남기기
        function renderFeedback() {
            // Expose submitFeedback to global scope
            window.submitFeedback = submitFeedback;

            return `
                <div class="flex flex-col flex-grow p-6 bg-gray-50 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-hyu-blue mb-6 border-b pb-2">HYUFA 의견 남기기</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">소중한 의견으로 똑똑한 HYUFA가 되겠습니다.</h3>

                        <div id="rating-stars" class="flex justify-center text-4xl text-gray-300 space-x-1 mb-6">
                            ${[1, 2, 3, 4, 5].map(i => `
                                <i class="fa-solid fa-star cursor-pointer hover:text-hyu-gold transition" data-rating="${i}" onclick="setRating(${i})"></i>
                            `).join('')}
                        </div>
                        <input type="hidden" id="feedback-rating" value="0">

                        <textarea id="feedback-text"
                                  placeholder="의견을 작성해주세요. (최대 500자)"
                                  maxlength="500"
                                  class="w-full h-32 p-3 border rounded-lg resize-none focus:ring-hyu-blue focus:border-hyu-blue mb-6"></textarea>

                        <div class="flex space-x-4 mt-auto border-t pt-4">
                            <button onclick="setAppState('MAIN_CHAT')" class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400 transition">
                                취소
                            </button>
                            <button onclick="submitFeedback()" class="flex-1 hyu-green text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition">
                                제출
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Sets the visual star rating.
         * @param {number} rating The star rating (1-5).
         */
        function setRating(rating) {
            document.getElementById('feedback-rating').value = rating;
            document.querySelectorAll('#rating-stars i').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.style.color = '#88774F'; // HYU Gold
                } else {
                    star.style.color = '#ccc';
                }
            });
        }
        window.setRating = setRating;


        /**
         * Submits feedback data to Firebase Firestore.
         */
        async function submitFeedback() {
            const rating = parseInt(document.getElementById('feedback-rating').value);
            const text = document.getElementById('feedback-text').value.trim();

            if (rating === 0 || text === '') {
                showMessage("별점과 의견을 모두 작성해주세요.");
                return;
            }

            try {
                const feedbackData = {
                    userId: userId,
                    rating: rating,
                    comment: text,
                    timestamp: new Date().toISOString(),
                    appId: appId
                };

                // Firestore path: /artifacts/{appId}/public/data/feedback
                const feedbackRef = collection(db, 'artifacts', appId, 'public', 'data', 'feedback');
                await addDoc(feedbackRef, feedbackData);

                showMessage("소중한 의견이 제출되었습니다. 감사합니다!");
                setAppState('MAIN_CHAT');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("의견 제출에 실패했습니다. (Error: " + e.code + ")");
            }
        }


        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center flex-grow p-8 text-center bg-gray-50">
                    <i class="fa-solid fa-circle-notch fa-spin text-5xl text-hyu-blue mb-4"></i>
                    <p class="text-xl font-semibold text-gray-700">서비스를 준비 중입니다...</p>
                    <p class="text-sm text-hyu-silver mt-2">잠시만 기다려주세요.</p>
                </div>
            `;
        }

        // --- 6. Initialization ---

        window.onload = async () => {
            // Wait for Firebase to initialize and sign in before rendering the initial state.
            await loadFAQData();
            await initializeFirebase();

            // Set up event listeners for chat input once the main chat is rendered (handled by renderApp/handleChatSubmit)
        };

        // Expose top-level functions to global scope for HTML onclick
        window.setAppState = setAppState;
        window.handleConsent = handleConsent;

    </script>
</body>
</html>